<!-- 
æ›´æ–°ï¼š
  1. 2.7.8
  2. ç·¨è¼¯é é¢é›²ç«¯åŒæ­¥
  3. æ‹–æ›³æ’åº fix
  
-->
<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />


<script>
  // APP version - ä¿®æ”¹é€™è£¡å³å¯ä¸€æ¬¡æ›´æ–°æ•´å€‹å°ˆæ¡ˆé¡¯ç¤º
  const APP_VERSION = 'v2.7.9';

  document.addEventListener('DOMContentLoaded', () => {
    const vEl = document.querySelector('.version');
    if (vEl) vEl.textContent = APP_VERSION + 'ã€€ã€€';
    // åŒæ­¥åˆ° titleï¼ˆè‹¥å°šæœªåŒ…å«ç‰ˆæœ¬ï¼‰
    if (document.title && !document.title.includes(APP_VERSION)) {
      document.title = `${document.title} ${APP_VERSION}`;
    }
  });
</script>


<link rel="icon" type="image/png" href="MA-icon.png" />
<title>MAç”¢ç”Ÿå™¨ (å–®æ¿)</title>
<style>
:root{
  --brand-blue:#003C96;
  --gray:#808080;
  --light-gray:#F5F5F5;
  --white:#FFFFFF;
  --soft-black:#1A1A1A;
  --card-radius:14px;
  --btn-radius:12px;
}
*{box-sizing:border-box;font-family:"Noto Sans TC",system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;font-size:90%;}
body{margin:0;background:var(--light-gray);color:var(--soft-black);padding:20px;}
.header{display:flex;align-items:center;gap:8px;margin-bottom:6px;}
.logo{width:28px;height:28px;border-radius:6px;background:var(--brand-blue);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;}
.title{font-size:18px;font-weight:700;}
.container{max-width:1100px;margin:0 auto;background:var(--white);border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,0.08);}
.tabs{display:flex;gap:8px;border-bottom:1px solid #eee;padding-bottom:6px;margin-bottom:18px;}
.tab{padding:3px 14px;border-radius:10px;cursor:pointer;background:transparent;color:var(--gray);font-weight:600;}
.tab.active{background:linear-gradient(90deg,rgba(0,60,150,0.08),rgba(0,60,150,0.02));color:var(--brand-blue);box-shadow:0 4px 10px rgba(0,60,150,0.06);}
.content{display:block;padding-top:0px;}
.grid{display:grid;grid-template-columns:1fr 315px;gap:18px;align-items:start;}
.card{background:var(--white);padding:14px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,0.04);}
.form-row{display:flex;gap:8px;margin-bottom:6px;align-items:center;} /* gap å¾ 10px æ”¹å° */
.form-row-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:6px;align-items:start;}
.form-row .label{width:72px;color:var(--gray);font-size:14px;text-align:left;display:flex;align-items:center;} /* label å¯¬åº¦è¼ƒå°ï¼Œé è¿‘ selectï¼›å‚ç›´ç½®ä¸­ */

/* åè…³å‹¾é¸æ¨£å¼ï¼šæ°´å¹³æ’åˆ—ã€å‚ç›´ç½®ä¸­ï¼Œå­—é«”èˆ‡é¸å–®æ¥è¿‘å¤§å° */
#reverseFootWrap{ display:inline-flex; align-items:center; gap:8px; margin-left:8px; font-size:14px; }
#reverseFoot{ width:18px; height:18px; margin-right:6px; vertical-align:middle; -webkit-appearance:auto; appearance:auto; }
.select,textarea,input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e6e6;font-size:14px;background:#fff;text-align:left;}
.select option{white-space:normal;}
textarea{min-height:50px;resize:vertical;}
.small{width:160px;}
.actions{display:flex;gap:8px;align-items:center;margin-top:6px;}
.btn{padding:10px 12px;border-radius:var(--btn-radius);border:0;cursor:pointer;font-weight:700;position:relative;display:inline-flex;
 align-items:center;
 justify-content:center;
 white-space:nowrap;
 line-height:1;
 height:auto;}
.btn.primary{background:var(--brand-blue);color:white;box-shadow:0 6px 18px rgba(0,60,150,0.12);}
.btn.ghost{background:transparent;border:1px solid #e6e6e6;color:var(--soft-black);}
.btn.clear{
  background:#d5d5d5;
  color:#3b3b3b;
  border:0;
  box-shadow:0 6px 12px rgba(231,76,60,0.12);
}
.btn.restore{
  background:#2b8e54;
  color:#fff;
  border:0;
  box-shadow:0 6px 12px rgba(46,204,113,0.12);
}
/* ä¿ç•™ ghost å¤–è§€æ™‚çš„é‚Šæ¡†ï¼ˆè‹¥åŒæ™‚æœ‰ ghost classï¼Œé™ä½ä¸é€æ˜åº¦ä»¥é¿å…éåº¦å°æ¯”ï¼‰*/
.btn.ghost.clear{ border:0; }
.btn.ghost.restore{ border:0; }
.copy-check{
  position:absolute;
  right:-28px;
  top:6px;
  font-size:12px;
  color:white;
  opacity:0;
  transition:opacity 0.2s, transform 0.12s;
  width:20px;
  height:20px;
  border-radius:50%;
  background:#2ecc71; /* ç¶ è‰²åœ“åœˆ */
  display:inline-flex;
  align-items:center;
  justify-content:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
  line-height:1;
  transform:scale(0.9);
}
/* ä½¿ç”¨ ::before é¡¯ç¤ºå‹¾è™Ÿå­—å…ƒï¼ˆé¿å…åŸæœ¬ <span> å…§æ–‡å­—é€ æˆæ’ç‰ˆå·®ç•°ï¼‰ */
.copy-check::before{ content: "âœ“"; font-size:12px; }
/* è‹¥ç”¨ JS åˆ‡æ› class æˆ–ç›´æ¥èª¿æ•´ opacityï¼Œéƒ½èƒ½é¡¯ç¤ºå‹•ç•« */
/*.copy-check.show{ opacity:1; transform:scale(1); }*/
.toast{
  position:fixed;
  right:24px;
  bottom:24px;
  background:rgba(0,0,0,0.8);
  color:white;
  padding:8px 12px;
  border-radius:10px;
  display:inline-block;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .2s,transform .2s;
  pointer-events:none;
  z-index:9999;
}
.toast.show{opacity:1;transform:translateY(0);}
.preview{white-space:pre-wrap;line-height:1.6;font-size:14px;color:var(--soft-black);padding:12px;border-radius:10px;border:1px dashed #eee;background:#fafafa;min-height:120px;}
.footer-note{font-size:12px;color:var(--gray);margin-top:10px;}
.degree-item{padding:4px 6px;border:1px solid #eee;margin-bottom:4px;border-radius:6px;cursor:grab;display:flex;justify-content:space-between;align-items:center;text-align:left;background:#fafafa;}
.degree-item span{flex:1;text-align:left;}
.degree-item button{background:none;border:none;color:#555;font-weight:700;cursor:pointer;font-size:14px;}
.remark-table{width:auto;border-collapse:collapse;margin-top:10px;table-layout:auto;}
.remark-table th, .remark-table td{border:1px solid #ddd;padding:6px;vertical-align:middle;text-align:center;white-space:nowrap;}
.remark-table th{background:rgba(0,60,150,0.08);color:var(--brand-blue);}
/* remark label margin èª¿æ•´ï¼Œé¿å…å‘ä¸‹åç§» */
.remark-cell label{display:inline-flex;align-items:center;gap:3px;margin-bottom:0;flex-wrap:wrap;}
.remark-cell input{transform:scale(1.2);}

/* æ–°å¢ï¼šremark-symbol åº•æ¡†æ¨£å¼ï¼ˆçµ¦é‚£äº›ç¬¦è™Ÿä¸€å€‹åº•æ¡†ï¼‰ */
.remark-symbol{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  /*vertical-align:middle;*/
  width:22px;        /* å›ºå®šå¯¬åº¦ï¼ˆä¾æœ€å¤§ç¬¦è™Ÿèª¿æ•´ï¼‰ */
  height:22px;       /* å›ºå®šé«˜åº¦ */
  padding:0;         /* ç§»é™¤å…§è·ä»¥ç¢ºä¿å›ºå®šå°ºå¯¸ */
  box-sizing:border-box;
  margin-right:6px;
  font-weight:700;
  font-size:14px;
  line-height:1.5;     /* ä½¿ç”¨ flex å°é½Š */
  color:#333;
  background:#fff;
  border:1px solid #e6e6e6;
  border-radius:6px;
  box-shadow:0 1px 2px rgba(0,0,0,0.04);
  transition:background .12s, border-color .12s, color .12s, transform .08s;
  /*transform: translateY(1px); /* reset anyåç§» */
}
/* è‹¥è¦ä¾ç‹€æ…‹å¾®èª¿é¡è‰²ï¼Œå¯ç”± JS åŠ  classï¼ˆç¤ºç¯„ç”¨ï¼Œéå¿…è¦ï¼‰ */
.remark-symbol.yes{ background:#fff; color:#08a715; }
.remark-symbol.half{ background:#fff; color:#403e3b; }
.remark-symbol.no{ background:#fff; color:#c0392b; }

/* ç‰ˆæœ¬è™Ÿæ¨£å¼ï¼ˆä½ è¦æ±‚çš„å°å­—ç°è‰²ï¼‰ */
.version {
  font-size: 12px;
  color: var(--gray);
  font-weight: 400;
  margin-left: 6px;
}

/* ä¿®æ”¹ï¼šå¿…å¡«æ¬„ä½æ¨™ç¤ºï¼ˆæ˜Ÿè™Ÿç§»åˆ°æ–‡å­—å¾Œï¼‰ */
.label.required::after{
  content: "*";
  color: #e74c3c; /* ç´…è‰²æ˜Ÿè™Ÿ */
  margin-left:2px;
  font-weight:600;
  display:inline-block;
}
.note-required{
  font-size:12px;
  color:var(--gray);
  margin-top:8px;
}

@media(max-width:980px){
  .grid{grid-template-columns:1fr;}
  .form-row, .form-row-2{flex-direction:column;align-items:flex-start;}
  .form-row .label{width:100%;}
  .small{width:100%;}
}

/* è®Šæ›´ï¼šç­‰ç´šã€è©•ç´šã€èƒ½åŠ›ã€é¡å‹å¯¬åº¦çµ±ä¸€ç‚º 160pxï¼ˆèˆ‡ .small ä¸€è‡´ï¼‰ï¼ŒdegreeSelect ä¿æŒåŸä¾†è¼ƒå¯¬ */
#level, #rating, #levelState, #type {
  margin-left: -8px;
  width: 100px;
}
/* degree select (ä¿ç•™) */
#degreeSelect{
  width:300px;
  display:inline-block;
  margin-left:0;
  transform:translateX(-8px);
  transition:transform .12s;
}

/* å¯å¾®èª¿çš„è©•ç´šèˆ‡ç‰¹è³ªï¼šä½¿ç”¨ inline-block + transform */
#rating, #character{
  width:100px;
  display:inline-block;
  margin-left:0;
  transform:translateX(-6px); /* â† èª¿æ•´é€™å€‹å€¼ï¼šæ­£å€¼å‘å³ï¼Œè² å€¼å‘å·¦ */
  transition:transform .12s;
}

/* å–®ä¸€æ¬„ä½è‡¨æ™‚å¾®èª¿ï¼šåœ¨ HTML åŠ  class="nudge" ä¸¦èª¿æ•´ä»¥ä¸‹è¦å‰‡å€¼ */
#rating.nudge{ transform:translateX(-12px); }
#character.nudge{ transform:translateX(-12px); }

/* æ‰‹æ©ŸéŸ¿æ‡‰ï¼šç§»é™¤åç§» */
@media(max-width:980px){
  #degreeSelect, #rating, #character{
    width:100% !important;
    transform:none !important;
    display:block;
    margin-left:0;
  }
}

/* å®¹å™¨é è¨­éš±è—ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
#requiredSkills, #coreSkills { display: none; }
/* æ ¸å¿ƒæŠ€èƒ½é¢æ¿æ¨£å¼ï¼ˆç¢ºä¿æŒ‰éˆ•èˆ‡æ¬„ä½é¡¯ç¤ºï¼‰ */
.style-block{
  background:var(--white);
  padding:8px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.04);
  display:flex;
  justify-content:flex-start;       /* æ”¹ç‚ºé å·¦æ’åˆ—ï¼Œæ‰€æœ‰ skill-col åœ¨åŒä¸€åˆ— */
  flex-wrap:nowrap;                 /* ä¸æ›è¡Œï¼Œä¿æŒå–®åˆ— */
  gap:4px;
  overflow-x:auto;                  /* è‹¥å¯¬åº¦ä¸è¶³å¯æ°´å¹³æ²å‹• */
  -webkit-overflow-scrolling:touch;
  align-items:flex-start;
  padding-bottom:6px;
}
.skill-col{
  flex:0 0 auto;                    /* å›ºå®šå¯¬åº¦ï¼Œä¸è¢«æ›è¡Œå£“ç¸® */
  width:120px;
  text-align:center;
  min-width:120px;
}
.skill-name{font-weight:700;margin-bottom:6px;color:var(--brand-blue);font-size:13px;}
.skill-buttons{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  row-gap:6px;
}
/* æ¯ä¸€åˆ—æŒ‰éˆ•å®¹å™¨ï¼šæ°´å¹³æ’åˆ— (I, IA) / (A, AC, C) */
.skill-row{ display:flex; gap:6px; justify-content:center; }

/* --- ç¸®å°æŒ‰éˆ•ä¸¦æ”¹ç‚ºæ–¹å½¢ï¼ˆèª¿æ•´ç‚º 20x20ï¼‰ --- */
.skill-buttons button{
  width:20px;
  height:20px;
  line-height:20px;
  padding:0;
  border:1px solid var(--gray);
  border-radius:4px; /* å°åœ“è§’ */
  background:var(--white);
  cursor:pointer;
  font-weight:700;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-size:10px;
  box-sizing:border-box;
}
.skill-buttons button.active{
  background:var(--brand-blue);
  color:var(--white);
  border-color:var(--brand-blue);
}
/* éš±è—æŠ€èƒ½æ¨™ç±¤é è¨­ï¼Œç”± JS æ§åˆ¶é¡¯ç¤º */
#skillsLabel { display: none; }
.tab[data-tab="editor"]{ display:none !important; }
#editorTab{ display:none !important; }
/* éš±è—åŒ¯å…¥/åŒ¯å‡ºèˆ‡ç·¨è¼¯ç”¨æŒ‰éˆ•ï¼Œæ”¹ä»¥ Google Sheet è‡ªå‹•è®€å– */
#exportBtn,#importBtn,#resetDefaultBtn,#exportAbilityBtn,#importAbilityBtn,#setAbilityDefaultBtn,#restoreAbilityDefaultBtn,#sheetIdInput,#sheetGidInput,#syncSheetBtn{ display:none !important; }
/* ç¨‹åº¦é …ç›®å‰çš„èƒ½åŠ›åˆ†é¡æŒ‰éˆ•ï¼ˆåœ“å½¢ã€è—è‰²æ–‡å­—ï¼‰ */
.ability-btn{
  width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;margin-right:8px;border:2px solid var(--brand-blue);color:var(--brand-blue);background:transparent;cursor:pointer;font-weight:700;font-size:12px;
}
.ability-btn.active{background:var(--brand-blue);color:#fff;}
</style>
</head>
<body>
<div class="header">
  <div class="logo">MA</div>
  <div class="title">è©•èªç”¢ç”Ÿå™¨(SB)<span class="version">v2.7.1ã€€ã€€</span><a href="https://docs.google.com/spreadsheets/d/1Sf5wgPqztXA6zYvyqUYZ-LIUBmBe9frX_kb-kstVq7A/edit?gid=992673677#gid=992673677" target="_blank" rel="noopener noreferrer">SBåˆä¸­éšMAç”¢ç”Ÿå™¨</a></div>
</div>

<div class="container">
  <div class="tabs" role="tablist">
    <div class="tab active" data-tab="generator">è©•èªç”¢ç”Ÿå™¨</div>
    <div class="tab" data-tab="editor">ç¨‹åº¦ç·¨è¼¯</div>
    <div class="tab" data-tab="need">éœ€åŠ å¼·ç·¨è¼¯</div>
    <div class="tab" data-tab="practice">å»ºè­°ç·´ç¿’ç·¨è¼¯</div>
    <div class="tab" data-tab="help">ä½¿ç”¨èªªæ˜</div>
  </div>

  <!-- è©•èªç”¢ç”Ÿå™¨ -->
  <div class="content" id="generatorTab">
    <div class="grid">
      <div class="card">
        <!-- <h3>å–®æ¿èª²ç¨‹</h3> -->

        <!-- æ”¹ç‚ºå–®æ¬„å®¹å™¨ï¼Œç¢ºä¿ï¼šç¬¬ä¸€åˆ— = ç­‰ç´šï½œè©•ç´šï½œèƒ½åŠ›ï¼›ç¬¬äºŒåˆ— = ç¨‹åº¦ï¼›ç¬¬ä¸‰åˆ— = é¡å‹ï½œç‰¹è³ª -->
        <div style="display:block;">
          <!-- ç¬¬ä¸€åˆ—ï¼šç­‰ç´š ï½œ è©•ç´š ï½œ èƒ½åŠ› -->
          <div class="form-row" style="width:100%;margin-bottom:8px;">
            <div class="label required">ç­‰ç´š</div>
            <select id="level" class="select small" required aria-required="true" title="å¿…å¡«ï¼šè«‹é¸æ“‡ç­‰ç´š">
              <option value="">è«‹é¸æ“‡</option>
              <option value="1">ç­‰ç´š1</option>
              <option value="2">ç­‰ç´š2</option>
              <option value="3">ç­‰ç´š3</option>
              <option value="4">ç­‰ç´š4</option>
              <option value="5">ç­‰ç´š5</option>
              <option value="6">ç­‰ç´š6</option>
              <option value="7">ç­‰ç´š7</option>
            </select>

            <div class="label">ã€€ã€€è©•ç´š</div>
            <select id="rating" class="select small" title="é¸æ“‡è©•ç´š">
              <option>æœªè©•ç´š</option>
              <option>è©•ç´šæœªé</option>
              <option>è©•ç´šéé—œã€æœªé”è·³æ¨™</option>
              <option>è©•ç´šéé—œ</option>
              <option>è·³ç´šéé—œ</option>
            </select>

            <div class="label required">ã€€èƒ½åŠ›</div>
            <select id="levelState" class="select small" required aria-required="true" title="å¿…å¡«ï¼šè«‹é¸æ“‡èƒ½åŠ›">
              <option value="">è«‹é¸æ“‡</option>
              <option>åˆ</option>
              <option>ä¸­</option>
              <option>é«˜</option>
            </select>
            <label id="reverseFootWrap" style="display:none;margin-left:8px;" title="åè…³ï¼šé‡åˆ°éœ€è¦åè…³çš„æƒ…æ³è«‹å‹¾é¸"><input id="reverseFoot" type="checkbox">åè…³</label>
          </div>

          <!-- ç¬¬äºŒåˆ—ï¼šç¨‹åº¦ï¼ˆèˆ‡é¡å‹ã€ç‰¹è³ªåŒåˆ—ï¼‰ -->
          <div class="form-row" style="width:100%;margin-bottom:8px;align-items:center;">
            <div class="label required">ç¨‹åº¦</div>
            <select id="degreeSelect" class="select" required aria-required="true" title="å¿…å¡«ï¼šè«‹é¸æ“‡ç¨‹åº¦" style="width:260px;margin-left:0;">
              <option value="">è«‹å…ˆé¸æ“‡ç­‰ç´š</option>
            </select>

            <!-- äº’æ›ï¼šå…ˆé¡¯ç¤ºã€Œç‰¹è³ªã€ï¼Œå†æ˜¯ã€Œé¡å‹ã€ã€‚åŒæ™‚å°‡ã€Œé¡å‹ã€éš±è—ï¼ˆä¿ç•™ DOM ä»¥å…å½±éŸ¿ JSï¼‰ã€‚ -->
            <div class="label">ã€€ ã€€ ç‰¹è³ª</div>
            <select id="character" class="select small" style="margin-left:0;">
              <option value="">è«‹é¸æ“‡</option>
              <option>ç©æ¥µå‹</option>
              <option>ç©©å¥å‹</option>
              <option>ä¿å®ˆå‹</option>
              <option>å®‰å…¨å‹</option>
              <option>è®ŠåŒ–å‹</option>          
            </select>

            <!-- éš±è—é¡å‹ï¼ˆä¿ç•™ element ä¾›ç¨‹å¼å­˜å–ï¼‰ -->
            <div class="label" style="display:none;">ã€€ ã€€é¡å‹</div>
            <select id="type" class="select small" style="margin-left:0; display:none;">
              <option value="">è«‹é¸æ“‡</option>
              <option>ğŸ‘€</option>
              <option>ğŸ¦¶</option>
              <option>ğŸ§ </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="label">å…¶ä»–å‚™è¨»</div>
          <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
            <textarea id="otherNotes" placeholder="å…¶ä»–å‚™è¨»..." style="min-height:50px;"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="label">éœ€åŠ å¼·</div>
          <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              
              <div id="needQuickButtons" style="position:relative;display:inline-block;">
                <button id="needQuickToggle" type="button" class="btn ghost" aria-haspopup="true" aria-expanded="false">å¿«é€Ÿæ–°å¢ â–¾</button>
                <!-- èˆ‡ practiceQuickList ä½¿ç”¨ç›¸åŒå®šä½é‚è¼¯ -->
                <div id="needQuickList" style="position:absolute;z-index:9999;display:none;left:calc(100% + 3px);bottom:0px;background:#fff;border:2px solid #e6e6e6;border-radius:8px;padding:8px;max-width:420px;min-width:220px;max-height:320px;overflow:auto;box-shadow:0 8px 20px rgba(0,0,0,0.08);flex-wrap:wrap;gap:6px;pointer-events:auto;"></div>
              </div>
            </div>
            <textarea id="needImprove" placeholder="è¼¸å…¥éœ€åŠ å¼·çš„é‡é»..."></textarea>
          </div>
        </div>

        <div class="form-row">
          <div class="label">å»ºè­°ç·´ç¿’</div>
          <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
            <!-- æ”¹ç‚ºå–®ä¸€ã€Œå¿«é€Ÿæ–°å¢ã€æŒ‰éˆ• + ä¸‹æ‹‰æ¸…å•ï¼ˆå¤±ç„¦æˆ–é»å¤–é¢é—œé–‰ï¼‰ -->
            <div id="practiceQuickButtons" style="position:relative;display:inline-block;vertical-align:middle;">
               <button id="practiceQuickToggle" type="button" class="btn ghost" aria-haspopup="true" aria-expanded="false">å¿«é€Ÿæ–°å¢ â–¾</button>
               <!-- æ”¾åœ¨æŒ‰éˆ•å³å´ã€èˆ‡æŒ‰éˆ•ä¸Šæ–¹å°é½Šï¼›å…§éƒ¨ä½¿ç”¨ flex-wrap æ§åˆ¶æ¯åˆ—æœ€å¤š 7 å€‹é …ç›® -->
               <div id="practiceQuickList" style="position:absolute;z-index:9999;display:none;left:calc(14% + 3px);bottom:0px;;background:#fff;border:2px solid #e6e6e6;border-radius:8px;padding:8px;max-width:420px;min-width:220px;max-height:320px;overflow:auto;box-shadow:0 8px 20px rgba(0,0,0,0.08);flex-wrap:wrap;gap:6px;pointer-events:auto;"></div>
            </div>
             <textarea id="practice" placeholder="è¼¸å…¥å»ºè­°ç·´ç¿’å…§å®¹..."></textarea>
           </div>
         </div>

        <div class="form-row" style="align-items:center;">
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="label" id="skillsLabel">å¿…è¦æŠ€èƒ½</div>
            <!-- å…¨éƒ¨å‹¾é¸/å–æ¶ˆæŒ‰éˆ•ï¼ˆé¡¯ç¤ºæ–¼æ¬„ä½å³å´ï¼‰ -->
            <button id="toggleRequiredAllBtn" type="button" class="btn ghost" style="padding:6px 8px;font-size:12px;">æ¸…é™¤</button>
          </div>
           <div style="flex:1">
             <!-- å¿…è¦æŠ€èƒ½ï¼ˆç­‰ç´š 1-4 é¡¯ç¤ºï¼‰ -->
             <div id="requiredSkills">
               <table class="remark-table" aria-hidden="false">
                 <thead>
                  <tr>
                    <th>
                      ä¸€ç´š
                      <!-- ä¸€ç´š æ—çš„åˆ‡æ›æŒ‰éˆ•ï¼ˆåŒæ™‚å‹¾é¸/å–æ¶ˆè©²æ¬„æ‰€æœ‰é …ç›®ï¼‰ -->
                      <button id="toggleLevel1Btn" type="button" class="btn ghost" style="margin-left:6px;padding:4px 6px;font-size:12px;">å…¨é¸</button>
                    </th>
                    <th>ä¸‰ç´š</th>
                    <th>å››ç´š</th>
                  </tr>
                 </thead>
                 <tbody>
                   <tr>
                     <td class="remark-cell">
                      <label><input type="checkbox" class="remark" value="å¹³åœ°ç§»å‹•" data-tristate="true">å¹³åœ°ç§»å‹•</label>
                      <label><input type="checkbox" class="remark" value="å®‰å…¨æ‘”å€’" data-tristate="true">å®‰å…¨æ‘”å€’</label>
                      <label><input type="checkbox" class="remark" value="ä¸‹çºœè»Š" data-tristate="true">ä¸‹çºœè»Š</label>
                     </td>
                     <td class="remark-cell">
                       <label><input type="checkbox" class="remark" value="ä¸‹æ¡¿é–‹æ©Ÿ" data-tristate="true">ä¸‹æ¡¿é–‹æ©Ÿ</label>
                     </td>
                     <td class="remark-cell">
                       <label><input type="checkbox" class="remark" value="ç›´æ¿å‡ºç•Œ" data-tristate="false">ç›´æ¿å‡ºç•Œ</label>
                     </td>
                   </tr>
                 </tbody>
               </table>
             </div>
            
             <!-- æ ¸å¿ƒæŠ€èƒ½ï¼ˆç­‰ç´š 7 é¡¯ç¤ºï¼‰ -->
             <div id="coreSkills" aria-hidden="true">
               <div class="style-block" id="skillBlockCore"></div>
               <!-- æ¢å¾©é è¨­æŒ‰éˆ•ï¼šå°‡æ‰€æœ‰æ ¸å¿ƒæŠ€èƒ½è¨­å®šç‚º I -->
               <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                 <button id="restoreCoreDefaultsBtn" class="btn ghost" type="button" style="padding:6px 8px;font-size:12px;">æ¢å¾©é è¨­</button>
                 <div id="coreOutput" class="output" style="margin-left:8px;margin-top:0;background:transparent;padding:6px;text-align:left;"></div>
               </div>
             </div>
           </div>
         </div>

        <!-- æ–°å¢èªªæ˜æ–‡å­— -->
        <div class="note-required" aria-hidden="false">ï¼Šç‚ºå¿…å¡«é …ï¼šç­‰ç´šã€èƒ½åŠ›ã€ç¨‹åº¦</div>

      </div>

      <div class="card">
        <h3>MAé è¦½</h3>
        <div id="preview" class="preview">å°šæœªç”¢ç”Ÿè©•èªã€‚</div>
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center;position:relative;">

        <!-- é‡æ–°æ’åºæŒ‰éˆ•ï¼šè¤‡è£½ã€æ¸…ç©ºè¼¸å…¥ã€æ¸…ç©ºå…¨éƒ¨ï¼ˆç”¢ç”ŸæŒ‰éˆ•ä¿ç•™ä½†éš±è—ï¼‰ -->
        <div style="position:relative;">
         <button class="btn primary" id="copyBtn">è¤‡è£½</button>
         <span id="copyCheck" class="copy-check"> </span>
       </div>

       <button class="btn ghost clear" id="toggleResetInputsBtn">æ¸…ç©ºè¼¸å…¥</button>
       <button class="btn ghost clear" id="toggleResetRestoreBtn">æ¸…ç©ºå…¨éƒ¨</button>

       <!-- ä¿ç•™ç”¢ç”ŸæŒ‰éˆ•ï¼ˆé è¨­ç”± script éš±è—ï¼‰ -->
       <button class="btn primary" id="genBtn" style="display:none;">ç”¢ç”Ÿè©•èª</button>

      </div>
      </div>
    </div>
  </div>

  <!-- ç¨‹åº¦ç·¨è¼¯ -->
  <div class="content" id="editorTab" style="display:none">
    <div class="card">
      <h3>ç¨‹åº¦å…§å®¹</h3>
      <div class="form-row">
        <div class="label">é¸æ“‡ç­‰ç´š</div>
        <select id="editLevel" class="select small">
          <option value="1">ç­‰ç´š1</option>
          <option value="2">ç­‰ç´š2</option>
          <option value="3">ç­‰ç´š3</option>
          <option value="4">ç­‰ç´š4</option>
          <option value="5">ç­‰ç´š5</option>
          <option value="6">ç­‰ç´š6</option>
          <option value="7">ç­‰ç´š7</option>
        </select>
      </div>
      <div class="form-row">
        <div class="label">ç¾æœ‰é …ç›®</div>
        <div style="flex:1">
          <ul id="degreeList" style="list-style:none;padding-left:0;margin:0;max-height:320px;overflow:auto;"></ul>
        </div>
      </div>
      <div class="form-row">
        <div class="label">æ–°å¢é …ç›®</div>
        <input id="newDegree" type="text" placeholder="è¼¸å…¥æ–°çš„ç¨‹åº¦..." />
        <button class="btn primary" id="addDegreeBtn">æ–°å¢</button>
      </div>
      <div class="actions">
        <button class="btn ghost" id="exportBtn">åŒ¯å‡º</button>
        <button class="btn ghost" id="importBtn">åŒ¯å…¥</button>
        <button class="btn ghost" id="resetDefaultBtn">é‡ç½®ç‚ºé è¨­</button>
        <button class="btn ghost" id="exportAbilityBtn">åŒ¯å‡ºèƒ½åŠ›</button>
        <button class="btn ghost" id="importAbilityBtn">åŒ¯å…¥èƒ½åŠ›</button>
        <button class="btn ghost" id="setAbilityDefaultBtn">è¨­ç‚ºèƒ½åŠ›é è¨­</button>
        <button class="btn ghost" id="restoreAbilityDefaultBtn">é‚„åŸèƒ½åŠ›é è¨­</button>
        <div style="display:flex;gap:6px;align-items:center;margin-left:8px;">
          <input id="sheetIdInput" class="select small" style="width:220px;padding:6px;" placeholder="Google Sheet ID" value="1kx9lS69H_ldkeKt3Nww_k65z8IMcRgTlm86uFJtdViA">
          <input id="sheetGidInput" class="select small" style="width:80px;padding:6px;" placeholder="gid" value="0">
          <button class="btn ghost" id="syncSheetBtn">åŒæ­¥ Google Sheet</button>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ å¼·å…§å®¹ç¯„æœ¬ï¼ˆéœ€åŠ å¼·ç·¨è¼¯ï¼‰ -->
  <div class="content" id="needTab" style="display:none">
    <div class="card">
      <h3>åŠ å¼·å…§å®¹</h3>
      <div class="form-row">
        <div class="label">é¸æ“‡ç­‰ç´š</div>
        <select id="editNeedLevel" class="select small">
          <option value="1">ç­‰ç´š1</option>
          <option value="2">ç­‰ç´š2</option>
          <option value="3">ç­‰ç´š3</option>
          <option value="4">ç­‰ç´š4</option>
          <option value="5">ç­‰ç´š5</option>
          <option value="6">ç­‰ç´š6</option>
          <option value="7">ç­‰ç´š7</option>
        </select>
      </div>

      <div class="form-row">
        <div class="label">ç¾æœ‰é …ç›®</div>
        <div style="flex:1">
          <ul id="needList" style="list-style:none;padding-left:0;margin:0;max-height:320px;overflow:auto;"></ul>
        </div>
      </div>

      <div class="form-row">
        <div class="label">æ–°å¢é …ç›®</div>
        <input id="newNeed" type="text" placeholder="è¼¸å…¥æ–°çš„éœ€åŠ å¼·è©æ¢..." />
        <button class="btn primary" id="addNeedBtn">æ–°å¢</button>
      </div>

      <div class="actions">
        <button class="btn ghost" id="exportNeedBtn">åŒ¯å‡º</button>
        <button class="btn ghost" id="importNeedBtn">åŒ¯å…¥</button>
        <button class="btn ghost" id="resetNeedBtn">é‡ç½®ç‚ºé è¨­</button>
      </div>
    </div>
  </div>

  <!-- å»ºè­°ç·´ç¿’ç¯„æœ¬ -->
  <div class="content" id="practiceTab" style="display:none">
    <div class="card">
      <h3>ç·´ç¿’å…§å®¹</h3>

      <!-- åŠ å…¥ç­‰ç´šé¸æ“‡ï¼Œèˆ‡ã€Œç¨‹åº¦ç·¨è¼¯ã€ä¸€è‡´ -->
      <div class="form-row">
        <div class="label">é¸æ“‡ç­‰ç´š</div>
        <select id="editPracticeLevel" class="select small">
          <option value="1">ç­‰ç´š1</option>
          <option value="2">ç­‰ç´š2</option>
          <option value="3">ç­‰ç´š3</option>
          <option value="4">ç­‰ç´š4</option>
          <option value="5">ç­‰ç´š5</option>
          <option value="6">ç­‰ç´š6</option>
          <option value="7">ç­‰ç´š7</option>
        </select>
      </div>

      <div class="form-row">
        <div class="label">ç¾æœ‰é …ç›®</div>
        <div style="flex:1">
          <ul id="practiceList" style="list-style:none;padding-left:0;margin:0;max-height:320px;overflow:auto;"></ul>
        </div>
      </div>
      <div class="form-row">
        <div class="label">æ–°å¢é …ç›®</div>
        <input id="newPractice" type="text" placeholder="è¼¸å…¥æ–°çš„ç·´ç¿’å…§å®¹..." />
        <button class="btn primary" id="addPracticeBtn">æ–°å¢</button>
      </div>
      <div class="actions">
        <button class="btn ghost" id="exportPracticeBtn">åŒ¯å‡º</button>
        <button class="btn ghost" id="importPracticeBtn">åŒ¯å…¥</button>
        <button class="btn ghost" id="resetPracticeBtn">é‡ç½®ç‚ºé è¨­</button>
      </div>
    </div>
  </div>

  <!-- åŠ å¼·å…§å®¹ç¯„æœ¬ï¼ˆéœ€åŠ å¼·ç·¨è¼¯ï¼‰ -->
  <div class="content" id="needTab" style="display:none">
    <div class="card">
      <h3>åŠ å¼·å…§å®¹</h3>
      <div class="form-row">
        <div class="label">é¸æ“‡ç­‰ç´š</div>
        <select id="editNeedLevel" class="select small">
          <option value="1">ç­‰ç´š1</option>
          <option value="2">ç­‰ç´š2</option>
          <option value="3">ç­‰ç´š3</option>
          <option value="4">ç­‰ç´š4</option>
          <option value="5">ç­‰ç´š5</option>
          <option value="6">ç­‰ç´š6</option>
          <option value="7">ç­‰ç´š7</option>
        </select>
      </div>

      <div class="form-row">
        <div class="label">ç¾æœ‰é …ç›®</div>
        <div style="flex:1">
          <ul id="needList" style="list-style:none;padding-left:0;margin:0;max-height:320px;overflow:auto;"></ul>
        </div>
      </div>

      <div class="form-row">
        <div class="label">æ–°å¢é …ç›®</div>
        <input id="newNeed" type="text" placeholder="è¼¸å…¥æ–°çš„åŠ å¼·å…§å®¹..." />
        <button class="btn primary" id="addNeedBtn">æ–°å¢</button>
      </div>

      <div class="actions">
        <button class="btn ghost" id="exportNeedBtn">åŒ¯å‡º</button>
        <button class="btn ghost" id="importNeedBtn">åŒ¯å…¥</button>
        <button class="btn ghost" id="resetNeedBtn">é‡ç½®ç‚ºé è¨­</button>
      </div>
    </div>
  </div>

  <!-- ä½¿ç”¨èªªæ˜ -->
  <div class="content" id="helpTab" style="display:none">
    <div class="card">
      <h3>ä½¿ç”¨èªªæ˜</h3>
      <div>
        <p><a href="https://docs.google.com/spreadsheets/d/1nJ4LBW_gb4ox7n8i8ktrq_1GBjCK1uSn846j4TbUT68/edit?usp=sharing" target="_blank" rel="noopener noreferrer">ã€å•é¡Œå›å ±ã€å„ªåŒ–å»ºè­°è«‹å¡«è¡¨å–®ã€‘</a></p>

        <p><strong>è©•èªç”¢ç”Ÿå™¨ï¼š</strong></p>
        <p>ã€€ï¼å¯å…ˆé¸ç­‰ç´šï¼Œå†é¸ç¨‹åº¦ï¼Œèƒ½åŠ›æœƒè‡ªå‹•å°æ‡‰é¸æ“‡ã€‚</p>
        <p>ã€€ï¼å¿«é€Ÿæ–°å¢å¯ç›´æ¥é»é¸åŠ å…¥ï¼Œç³»çµ±æœƒä»¥ä¸­æ–‡é “è™Ÿè‡ªå‹•åˆ†éš”ã€‚</p>
        <p>ã€€ï¼å¿…è¦æŠ€èƒ½æœƒä¾ç…§ç­‰ç´šé¡¯ç¤ºå°æ‡‰é¸é …ã€‚</p>

        <p><strong>éœ€åŠ å¼·ç·¨è¼¯ã€å»ºè­°ç·´ç¿’ç·¨è¼¯ï¼š</strong></p>
        <p>ï¼å¯ç›´æ¥æ–°å¢è‡ªå·±å¸¸ç”¨çš„è©æ¢ï¼Œç³»çµ±æœƒåŒæ­¥åˆ°é›²ç«¯ï¼ˆè‹¥å·²è¨­å®šï¼‰ã€‚</p>
        <p>ï¼æ–°å¢æˆ–åˆªé™¤è©æ¢æ™‚ï¼Œè«‹ç•™æ„æ˜¯å¦ç¬¦åˆè©²ç­‰ç´šå…§å®¹åŠèªæ„ã€‚</p>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast">å·²è¤‡è£½</div>

<!-- Firebase SDK (compat for simple integration) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
  // Firebase config (provided by user)
  try{
    const firebaseConfig = {
      apiKey: "AIzaSyA5KfuklK3HLcshb8ickwFhIJWuOzprJGk",
      authDomain: "ma-tool-data.firebaseapp.com",
      databaseURL: "https://ma-tool-data-default-rtdb.firebaseio.com",
      projectId: "ma-tool-data",
      storageBucket: "ma-tool-data.firebasestorage.app",
      messagingSenderId: "630905702996",
      appId: "1:630905702996:web:ec9a5d8a0c948218a43bc1"
    };
    if(window.firebase && !window._maFirebaseInitialized){
      firebase.initializeApp(firebaseConfig);
      window._maFirebaseInitialized = true;
      window.maDb = firebase.database();
      console.log('Firebase initialized for MA-tool');
    }
  }catch(e){ console.warn('Firebase init failed', e); }

  // helper: write and read
  function firebaseWrite(key, obj){
    try{
      if(window.maDb){
        return window.maDb.ref(key).set(obj);
      }
    }catch(e){ console.warn('firebaseWrite', e); }
    return Promise.resolve();
  }
  function firebaseRead(key){
    return new Promise((resolve)=>{
      try{
        if(window.maDb){
          window.maDb.ref(key).once('value').then(s=> resolve(s.val()));
        } else resolve(null);
      }catch(e){ console.warn('firebaseRead', e); resolve(null); }
    });
  }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
// ---------- é è¨­è³‡æ–™ ----------
const defaultDegreeOptions = {
  "1":[ /*"ç„¡æ³•æ”¾æ‰‹",
        "å¯æ”¾æ‰‹1-3ç§’",
        "å¯æ”¾æ‰‹3ç§’ä»¥ä¸Š",
        "å¯æ”¾æ‰‹5-10ç§’",
        "å¯æŒçºŒæ”¾æ‰‹æ»‘è¡Œ",
        "å¯æ§åˆ¶ä¸Šä¸‹"*/
      ],
  "2":[ /*"é›™æ‰‹æ‰¶æ¡¿å·¦å³",
        "å–®æ‰‹æ‰¶æ¡¿å·¦å³",
        "å¯å·¦å³ä¸æ‰¶æ¡¿ï¼Œä¸ç©©éœ€ç¨å¾®æ‰¶æ¡¿è¼”åŠ©ã€‚",
        "ä¸æ‰¶æ¡¿å·¦å³ï¼Œéœ€è¼”åŠ©æ›é‚Šã€‚",
        "å¯ç¨å¾®è½è‘‰é£„ï¼Œæ›é‚Šå®Œéœ€è¼•ç¢°æ¡¿è¼”åŠ©ã€‚",
        "å¯é›¢æ¡¿è½è‘‰é£„ã€‚",
        "å¯é›¢æ¡¿å¼·é£„ã€‚"*/
      ],
  "3":[ /*"ç„¡æ³•æ©«æ»‘æ”¾æ‰‹ã€‚",
        "å¯åŸåœ°æ”¾æ‰‹3ç§’ä»¥ä¸Šã€‚",
        "é›™æ‰‹æ‰¶æ¡¿å¯æ”¹è®Šæ¿å­è§’åº¦ï¼Œæˆ–å·²é–‹å§‹å·¦å³ã€‚",
        "å–®æ‰‹æ‰¶æ¡¿å·¦å³",
        "å¯å·¦å³ä¸æ‰¶æ¡¿ï¼Œä¸ç©©éœ€ç¨å¾®æ‰¶æ¡¿è¼”åŠ©ã€‚",
        "ä¸æ‰¶æ¡¿å·¦å³ï¼Œéœ€è¼”åŠ©æ›é‚Šã€‚",
        "å¯ç¨å¾®è½è‘‰é£„ï¼Œæ›é‚Šå®Œéœ€è¼•ç¢°æ¡¿è¼”åŠ©ã€‚",
        "å¯é›¢æ¡¿è½è‘‰é£„ã€‚",
        "å¯é›¢æ¡¿å¼·é£„ã€‚"*/
      ],
  "4":[ /*"æ­£åœ¨é€²è¡Œä¸‹åŠå¼§ç·´ç¿’ï¼ŒHé‚„ä¸å¤ªç†Ÿç·´ã€‚",
        "æ­£åœ¨é€²è¡Œä¸‹åŠå¼§ç·´ç¿’ï¼ŒTé‚„ä¸å¤ªç†Ÿç·´ã€‚",
        "ä¸‹åŠå¼§å·²ç†Ÿç·´ã€‚",
        "æ­£åœ¨é€²è¡Œä¸ŠåŠå¼§ç·´ç¿’ï¼ŒHæŠ¬å‡ä¸ŠåŠå¼§é‚„ä¸å¤ªç†Ÿç·´ã€‚",
        "æ­£åœ¨é€²è¡Œä¸ŠåŠå¼§ç·´ç¿’ï¼ŒTæŠ¬å‡ä¸ŠåŠå¼§é‚„ä¸å¤ªç†Ÿç·´ã€‚",
        "å¯åˆ†è§£çš„æ»‘å‡ºHã€Tï¼Œä¸Šã€ä¸‹åŠå¼§å››å€‹å‹•ä½œï¼Œä½†ç©©å®šæ€§é‚„å¯æå‡ã€‚",
        "å››å€‹å‹•ä½œçš†å¯ç©©å®šåˆ†è§£å®Œæˆï¼Œé€£çµä¸é †ã€‚",
        "å¯é †åˆ©é€£çµå…©å´é›™Cã€‚",
        "å¯æŠ¬å‡é›¢æ¡¿ï¼Œç›´æ¿è¼•ç¢°å®ŒæˆCã€‚"*/
      ],
  "5":[ /*"å¯è—‰ç”±è¼”åŠ©å®Œæˆé›™Cï¼Œå°šç„¡æ³•é›¢æ¡¿å®Œæˆä»»ä¸€é‚Šçš„Cã€‚",
        "T2H å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œæœªé”æ¨™ï¼›H2T å°šç„¡æ³•ç¨ç«‹å®Œæˆã€‚",
        "T2H å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œé”æ¨™ï¼›H2T å°šç„¡æ³•ç¨ç«‹å®Œæˆã€‚",
        "T2H å°šç„¡æ³•ç¨ç«‹å®Œæˆï¼›H2T å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œæœªé”æ¨™ã€‚",
        "T2H å°šç„¡æ³•ç¨ç«‹å®Œæˆï¼›H2T å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œé”æ¨™ã€‚",
        "T2H å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œæœªé”æ¨™ï¼›H2T å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œæœªé”æ¨™ã€‚",
        "T2H å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œé”æ¨™ï¼›H2T å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œæœªé”æ¨™ã€‚",
        "T2H å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œæœªé”æ¨™ï¼›H2T å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œé”æ¨™",
        "å…©å´Cçš†å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œ3æ ¼å…§ã€‚",
        "å…©å´Cçš†å¯é›¢æ¡¿ç¨ç«‹å®Œæˆï¼Œ2æ ¼å…§ã€‚"*/
      ],
  "6":[ /*"å¯è¼”åŠ©å®ŒæˆS è·¯å¾‘ï¼Œå®¹æ˜“éåº¦ä¾è³´è¼”åŠ©ã€‚",
        "å¯è¼”åŠ©å®ŒæˆS è·¯å¾‘ï¼Œè¼•å¾®ä¾è³´è¼”åŠ©ã€‚",
        "æ²’æœ‰è¼”åŠ©ç‹€æ…‹ä¸‹ï¼Œç„¡æ³•æ‰¾åˆ°Sè·¯å¾‘ã€‚",
        "æœ‰è‡ªè¡Œå®ŒæˆSè·¯å¾‘çš„èƒ½åŠ›ï¼Œä½†å®¹æ˜“åœ¨2-3å€‹å½ä¹‹å¾Œå¤±èª¤ã€‚",
        "æœ‰è‡ªè¡Œå®ŒæˆSè·¯å¾‘çš„èƒ½åŠ›ï¼Œä½†å®¹æ˜“åœ¨4-5å€‹å½ä¹‹å¾Œå¤±èª¤ã€‚",
        "å¯é›¢æ¡¿Sï¼Œåšé–‰é–å¼å½å½¢ï¼Œç´„40ç§’å®Œæˆ6å€‹å½ï¼Œä¸ç©©å®šï¼Œæœªé”æ¨™ã€‚",
        "å¯é›¢æ¡¿Sï¼Œåšé–‰é–å¼å½å½¢ï¼Œç´„40ç§’å®Œæˆ6å€‹å½ï¼Œç©©å®šé”æ¨™ã€‚",
        "å¯é›¢æ¡¿Sï¼Œåšè¼ƒé–‹æ”¾å¼å½å½¢ï¼Œå¯åœ¨20-30ç§’å®Œæˆ6å€‹å½ï¼Œä¸ç©©å®šï¼Œå»ºè­°åœ¨ä¸­éšç†Ÿç·´ã€‚",
        "å¯é›¢æ¡¿Sï¼Œåšè¼ƒé–‹æ”¾å¼å½å½¢ï¼Œå¯åœ¨20-30ç§’å®Œæˆ6å€‹å½ï¼Œç©©å®šï¼Œå»ºè­°å»é«˜éšã€‚"*/
      ],
  "7":["H2Tå¯ææ›","å¯é›¢æ¡¿ææ›S","å¤§ä¸­å°å½ å¯è·Ÿæ»‘","å¯åœ˜èº«é›¢æ¡¿","å¤§ä¸­å°å½ã€åœ˜èº«å¯è·Ÿæ»‘","çš†å¯è·Ÿæ»‘"]
};

// ---------- åˆä½µçš„ç¨‹åº¦ + èƒ½åŠ› é è¨­ï¼ˆå¯ç›´æ¥åœ¨ç¨‹å¼ç¢¼ä¸­ç·¨è¼¯ï¼‰
// æ ¼å¼ï¼š
// const defaultDegreeOptionsWithAbility = {
//   "1": [ { t: 'è©æ¢æ–‡å­—', a: 'åˆ' }, { t: 'å¦ä¸€æ¢', a: 'ä¸­' }, ... ],
//   "2": [ ... ]
// }
// ä½ å¯ä»¥ç›´æ¥åœ¨æ­¤ä¿®æ”¹è©æ¢èˆ‡èƒ½åŠ›åˆ†é¡ï¼Œç¨‹å¼æœƒä»¥æ­¤ç‚ºåŸºåº•åˆå§‹åŒ– default è³‡æ–™ã€‚
const defaultDegreeOptionsWithAbility = (function(){
  const cycle = ['åˆ','ä¸­','é«˜'];
  const out = {};
  for(const lv in defaultDegreeOptions){
    out[lv] = (defaultDegreeOptions[lv] || []).map((txt, idx)=>({ t: txt, a: cycle[idx % cycle.length] }));
  }
  return out;
})();

// ä½¿ç”¨ä¸Šæ–¹åˆä½µé è¨­ä¾†è¦†å¯«åŸæœ¬çš„ defaultDegreeOptionsï¼ˆæ–¹ä¾¿ç¨‹å¼ä¸­å…¶ä»–åœ°æ–¹ç¹¼çºŒä½¿ç”¨åŸæœ¬çš„é™£åˆ—å½¢å¼ï¼‰
for(const lv in defaultDegreeOptionsWithAbility){
  defaultDegreeOptions[lv] = defaultDegreeOptionsWithAbility[lv].map(x=>x.t);
}

// è‹¥å°šæœªæœ‰é è¨­çš„ ability mapï¼Œå‰‡ä»¥ combined é è¨­ç”¢ç”Ÿä¸¦å„²å­˜
if(!localStorage.getItem('degreeAbilityMap_v1')){
  const initial = {};
  for(const lv in defaultDegreeOptionsWithAbility){
    initial[lv] = {};
    defaultDegreeOptionsWithAbility[lv].forEach(obj=>{ initial[lv][obj.t] = obj.a; });
  }
  try{ localStorage.setItem('degreeAbilityMap_v1', JSON.stringify(initial)); }catch(e){}
}

// checkbox é¡¯ç¤ºåç¨± -> è¼¸å‡ºçŸ­å map
const remarkMap = {
  "å¹³åœ°ç§»å‹•":"å¹³ç§»",
  "å®‰å…¨æ‘”å€’":"å®‰æ‘”",
  "ä¸‹çºœè»Š":"çºœè»Š",
  "ä¸‹æ¡¿é–‹æ©Ÿ":"ä¸‹æ¡¿",
  "ç›´æ¿å‡ºç•Œ":"å‡ºç•Œ"
};

// ---------- storage helpers ----------
function getCustomOptions(){ const s = localStorage.getItem('customDegreeOptions'); return s ? JSON.parse(s) : {}; }
function saveCustomOptions(d){ localStorage.setItem('customDegreeOptions', JSON.stringify(d)); }
function getDegreeOptions(){ return {...defaultDegreeOptions, ...getCustomOptions()}; }

// ---------- degree ability mapping (storage) ----------
function getAbilityMap(){ try{ const s = localStorage.getItem('degreeAbilityMap_v1'); return s ? JSON.parse(s) : {}; }catch(e){return {}; } }
function saveAbilityMap(m){ try{ localStorage.setItem('degreeAbilityMap_v1', JSON.stringify(m)); }catch(e){}
}
// Ensure ability map for level aligns with provided list (preserve existing mappings when possible)
function ensureAbilityMapForLevel(lvl, list){ if(!lvl) return {}; const map = getAbilityMap(); map[lvl] = map[lvl] || {}; const prev = {...map[lvl]}; const ordered = {}; const cycle = ['åˆ','ä¸­','é«˜']; list.forEach((item, idx)=>{ if(prev[item]) ordered[item] = prev[item]; else ordered[item] = cycle[idx % cycle.length]; }); map[lvl] = ordered; saveAbilityMap(map); return map[lvl]; }
function getAbilityFor(lvl, degree){ const m = getAbilityMap(); if(!m || !m[lvl]) return ''; return m[lvl][degree] || ''; }

// ---------- å»ºè­°ç·´ç¿’ï¼šé è¨­èˆ‡ storageï¼ˆä¾ç­‰ç´šåˆ†é¡ï¼‰ ----------
const defaultPracticeTemplatesByLevel = {
  "1":[
    "éœæ…‹ä¸‹æ»‘",
    "è…³è¸ç›¸æ’²",
    "é–‹æ©Ÿæ‘”"
    ],

"2":[
    "ä¸‹è‚¢æ—‹è½‰",
    "é‡å¿ƒè½‰ç§»",
    "ä¸€å½äºŒç«™",
    "åˆ†é›¢ç”¨åˆƒ"
    ],

"3":[
    "ä¸€å½äºŒç«™",
    "ä¸‹è‚¢æ—‹è½‰",
    "é‡å¿ƒè½‰ç§»"
    ],

"4":[
    "ä¸‹è‚¢æ—‹è½‰",
    "é›¢æ¡¿æ›åˆƒ",
    "æ›åˆƒæ„Ÿå—",
    "ç›´æ»‘ç«™å§¿",
    "æŠ¹å¥¶æ²¹"
    ],

"5":[
    "æ—‹è½‰æŠ¹å¥¶æ²¹",
    "æ“¦æ¿æ“¦",
    "é›¢æ¡¿åŸåœ°è½‰ç›´"
    ],

"6":[
    "Nikeå‹¾å‹¾",
    "å¼·åŠ›è½è‘‰é£„"
    ],

"7":[
    "æ‰¶æ¡¿åœ˜èº«æ›åˆƒ",
    "ERæ»¾åˆƒ",
    "æ‰¶æ¡¿æ…¢é€Ÿææ›"
    ]
};

function getPracticeTemplates(){
  try {
    const s = localStorage.getItem('practiceTemplates_v1');
    return s ? JSON.parse(s) : null;
  } catch(e){ return null; }
}
function savePracticeTemplates(obj){
  try { localStorage.setItem('practiceTemplates_v1', JSON.stringify(obj)); } catch(e){}
  // push to Firebase if available
  try{ if(window.maDb){ firebaseWrite('practiceTemplates_v1', obj).catch(()=>{}); } }catch(e){}
}
function ensurePracticeTemplatesInitialized(){
  // æ”¹ç‚ºï¼šè‹¥æœ‰ Firebaseï¼ˆé ç«¯ï¼‰å‰‡ä¸ä»¥å…§å»ºé è¨­è¦†è“‹é ç«¯ã€‚
  // åªæœ‰åœ¨æ²’æœ‰ Firebase å¯ç”¨ä¸”æœ¬æ©Ÿ localStorage ä¹Ÿæ²’æœ‰è³‡æ–™æ™‚ï¼Œæ‰æœƒä»¥å…§å»º default ä½œç‚ºé›¢ç·šé è¨­ã€‚
  const cur = getPracticeTemplates();
  if(window.maDb){
    // è‹¥ä½¿ç”¨ Firebaseï¼Œä¸è¦è‡ªå‹•å¯«å…¥å…§å»ºé è¨­ä»¥å…è¦†è“‹é ç«¯è³‡æ–™ã€‚
    // è‹¥æœ¬æ©Ÿå·²æœ‰è³‡æ–™å‰‡ä¿ç•™ï¼›å¦å‰‡ç­‰å¾…é ç«¯åŒæ­¥å™¨ï¼ˆon value listenerï¼‰æˆ–ä½¿ç”¨è€…æ‰‹å‹•æ–°å¢ã€‚
    return;
  }
  // ç„¡ Firebaseï¼šç¶­æŒèˆŠæœ‰ local fallback è¡Œç‚ºï¼ˆè‹¥ localStorage ç„¡è³‡æ–™å‰‡åˆå§‹åŒ–å…§å»ºé è¨­ï¼‰
  if(!cur || typeof cur !== 'object'){
    savePracticeTemplates(JSON.parse(JSON.stringify(defaultPracticeTemplatesByLevel)));
    return;
  }
  let changed = false;
  for(const lvl in defaultPracticeTemplatesByLevel){
    if(!Array.isArray(cur[lvl]) || cur[lvl].length === 0){
      cur[lvl] = [...defaultPracticeTemplatesByLevel[lvl]];
      changed = true;
    }
  }
  if(changed) savePracticeTemplates(cur);
}

// ---------- éœ€åŠ å¼·ï¼šé è¨­èˆ‡ storageï¼ˆä¾ç­‰ç´šåˆ†é¡ï¼‰ ----------
const defaultNeedTemplatesByLevel = {
  "1": ["å‰è»Šç¶­æŒ","ç«™å§¿å±…ä¸­","æ¿åˆƒå¹³è¡¡"],
  "2": ["è§’åº¦æ§åˆ¶","é‡å¿ƒè½‰ç§»"],
  "3": ["é‡å¿ƒè½‰æ›æ™‚æ©Ÿ","è…³è¸æ§åˆ¶"],
  "4": ["æŒçºŒæ—‹è½‰","é‡å¿ƒé å‰è…³","æŠ¬å‡å£“åŠ›"],
  "5": ["æ–œä¸Šè·¯å¾‘ç©©å®š","æ›åˆƒå‹•ä½œ","è½‰ç›´èƒ½åŠ›"],
  "6": ["ä¸‹åŠåœ“å£“åŠ›æ§åˆ¶","åŠ æ¸›å£“æ™‚æ©Ÿ"],
  "7": ["åœ˜èº«æ”¶ç¸®æ™‚æ©Ÿ","å°å½æ—‹è½‰æ™‚æ©Ÿ"]
};

function getNeedTemplates(){
  try {
    const s = localStorage.getItem('needTemplates_v1');
    return s ? JSON.parse(s) : null;
  } catch(e){ return null; }
}
function saveNeedTemplates(obj){
  try { localStorage.setItem('needTemplates_v1', JSON.stringify(obj)); } catch(e){}
  // push to Firebase if available
  try{ if(window.maDb){ firebaseWrite('needTemplates_v1', obj).catch(()=>{}); } }catch(e){}
}
function ensureNeedTemplatesInitialized(){
  // èˆ‡ practice åŒç†ï¼šè‹¥æœ‰ Firebase å‰‡ä¸è¦ä»¥å…§å»ºé è¨­è¦†è“‹é ç«¯
  const cur = getNeedTemplates();
  if(window.maDb){
    return;
  }
  if(!cur || typeof cur !== 'object'){
    saveNeedTemplates(JSON.parse(JSON.stringify(defaultNeedTemplatesByLevel)));
    return;
  }
  let changed = false;
  for(const lvl in defaultNeedTemplatesByLevel){
    if(!Array.isArray(cur[lvl]) || cur[lvl].length === 0){
      cur[lvl] = [...defaultNeedTemplatesByLevel[lvl]];
      changed = true;
    }
  }
  if(changed) saveNeedTemplates(cur);
}

// ---------- DOM helper ----------
const $ = id => document.getElementById(id);

// ---------- ä¿å­˜è¡¨å–®ç‹€æ…‹ ----------
let savedInputState = {};

// ---------- load degree select for generator ----------
function loadDegreeOptions(){
  const lvl = $('level').value;
  const sel = $('degreeSelect');
  sel.innerHTML = '';
  const opts = getDegreeOptions();
  if(lvl && opts[lvl]){
    sel.appendChild(new Option('è«‹é¸æ“‡ç¨‹åº¦',''));
    // è‹¥ä½¿ç”¨è€…å·²é¸æ“‡ã€Œèƒ½åŠ›ã€ï¼Œå‰‡åƒ…é¡¯ç¤ºå°æ‡‰èƒ½åŠ›çš„è©æ¢ï¼›è‹¥ç„¡å°æ‡‰å‰‡å›é€€é¡¯ç¤ºå…¨éƒ¨
    const ability = $('levelState') ? $('levelState').value : '';
    const abilityMap = getAbilityMap();
    let list = opts[lvl].slice();
    if(ability){
      const filtered = list.filter(o => abilityMap[lvl] && abilityMap[lvl][o] === ability);
      if(filtered.length > 0) list = filtered;
      else list = []; // è‹¥æ²’æœ‰å°æ‡‰å‰‡æš«æ™‚é¡¯ç¤ºç©ºï¼ˆä½¿ç”¨è€…å¯æ”¹ç‚ºä¸é¸æ“‡èƒ½åŠ›ï¼‰
    }
    if(list.length === 0 && !ability){
      // ç„¡èƒ½åŠ›ç¯©é¸ä¸”ç„¡é …ç›®ï¼Œé¡¯ç¤ºç©ºè¨Šæ¯
      sel.appendChild(new Option('ç›®å‰ç„¡ç¨‹åº¦é …ç›®',''));
    } else if(list.length === 0 && ability){
      // è‹¥ç¯©é¸å¾Œæ²’æœ‰é …ç›®ï¼Œæç¤ºä¸¦æä¾›å…¨éƒ¨é¸é …ï¼ˆfallbackï¼‰
      sel.appendChild(new Option('æ­¤èƒ½åŠ›ç„¡å°æ‡‰é …ç›® - é¡¯ç¤ºå…¨éƒ¨',''));
      opts[lvl].forEach(o => sel.appendChild(new Option(o,o)));
    } else {
      list.forEach(o => sel.appendChild(new Option(o,o)));
    }
  } else {
    sel.appendChild(new Option('è«‹å…ˆé¸æ“‡ç­‰ç´š',''));
  }
}

// ---------- load degree list for editor ----------
function loadDegreeList(){
  const lvlEl = $('editLevel');
  if(!lvlEl) return;
  const lvl = lvlEl.value;
  const list = $('degreeList');
  if(!list) return;
  list.innerHTML = '';

  // ç¢ºä¿ custom å­˜åœ¨ï¼ˆè‹¥æ²’æœ‰ï¼Œåˆå§‹åŒ–ç‚º default copyï¼‰
  const custom = getCustomOptions();
  if(!custom[lvl] || !Array.isArray(custom[lvl]) || custom[lvl].length === 0){
    custom[lvl] = defaultDegreeOptions[lvl] ? [...defaultDegreeOptions[lvl]] : [];
    saveCustomOptions(custom);
  }

  const opts = custom[lvl];
  // ensure ability mapping exists for this level (preserve existing mappings)
  ensureAbilityMapForLevel(lvl, opts);
  opts.forEach((opt, idx)=>{
    const li = document.createElement('li');
    li.className = 'degree-item';

    // èƒ½åŠ›åˆ†é¡æŒ‰éˆ•
    const abilityBtn = document.createElement('button');
    abilityBtn.className = 'ability-btn';
    const curMap = getAbilityMap();
    const curAbility = (curMap[lvl] && curMap[lvl][opt]) ? curMap[lvl][opt] : '';
    abilityBtn.textContent = curAbility || 'åˆ';
    if(curAbility) abilityBtn.classList.add('active');
    abilityBtn.title = 'é»æ“Šä»¥åˆ‡æ›èƒ½åŠ›ï¼šåˆ / ä¸­ / é«˜';
    abilityBtn.addEventListener('click', ()=>{
      const order = ['åˆ','ä¸­','é«˜'];
      const cur = getAbilityFor(lvl, opt) || 'åˆ';
      const next = order[(order.indexOf(cur) + 1) % order.length];
      const m = getAbilityMap(); m[lvl] = m[lvl] || {}; m[lvl][opt] = next; saveAbilityMap(m);
      abilityBtn.textContent = next; abilityBtn.classList.add('active');
      try{ loadDegreeOptions(); }catch(e){}
    });

    const span = document.createElement('span');
    span.textContent = opt;
    span.title = 'é›™æ“Šç·¨è¼¯';

    // å…§åµŒç·¨è¼¯ï¼šé›™æ“Šå¾Œä»¥ input å–ä»£ spanï¼ŒEnter/blur å„²å­˜ï¼ŒEsc å–æ¶ˆ
    span.addEventListener('dblclick', ()=>{
      if(li.querySelector('input')) return;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = opt;
      input.style.width = '100%';
      input.style.padding = '6px';
      input.style.borderRadius = '6px';
      input.style.border = '1px solid #ccc';
      li.replaceChild(input, span);
      input.focus();
      input.select();

      const cancel = ()=>{ if(li.contains(input)) li.replaceChild(span, input); };

      const save = ()=>{
        const v = input.value.trim();
        if(v === ''){ alert('å…§å®¹ä¸å¯ç‚ºç©º'); input.focus(); return; }
        const cur = getCustomOptions();
        cur[lvl] = cur[lvl] || [...(defaultDegreeOptions[lvl] || [])];
        const oldKey = opt;
        cur[lvl][idx] = v;
        saveCustomOptions(cur);
        // sync ability mapping: move old key mapping to new key
        const amap = getAbilityMap(); amap[lvl] = amap[lvl] || {};
        amap[lvl][v] = amap[lvl][oldKey] || 'ä¸­';
        if(amap[lvl][oldKey]) delete amap[lvl][oldKey];
        saveAbilityMap(amap);
        loadDegreeList();
        loadDegreeOptions();
      };

      input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); save(); } else if(e.key === 'Escape'){ e.preventDefault(); cancel(); } });
      input.addEventListener('blur', ()=>{ if(input.value.trim() === opt) cancel(); else save(); });
    });

    const btn = document.createElement('button');
    btn.textContent = 'âœ•';
    btn.onclick = ()=>{
      if(!confirm('åˆªé™¤æ­¤è©æ¢ï¼Ÿ')) return;
      const cur = getCustomOptions();
      cur[lvl] = cur[lvl].filter((_,i)=>i!==idx);
      saveCustomOptions(cur);
      // remove ability mapping for deleted item
      const amap = getAbilityMap(); if(amap[lvl] && amap[lvl][opt]){ delete amap[lvl][opt]; saveAbilityMap(amap); }
      loadDegreeList();
      loadDegreeOptions();
    };

    li.appendChild(abilityBtn);
    li.appendChild(span);
    li.appendChild(btn);
    list.appendChild(li);
  });

  // enable drag reorder
  try {
    Sortable.create(list, {
      animation:150,
      onEnd: function(){
        const newOrder = Array.from(list.querySelectorAll('li span')).map(s=>s.textContent);
        const cur = getCustomOptions();
        cur[$('editLevel').value] = newOrder;
        saveCustomOptions(cur);
        loadDegreeOptions();
      }
    });
  } catch(e){}
}

// ---------- add degree ----------
$('addDegreeBtn').onclick = ()=>{
  const txt = $('newDegree').value.trim(); if(!txt) return alert('è«‹è¼¸å…¥è©æ¢');
  const lvl = $('editLevel').value;
  const custom = getCustomOptions(); const merged = getDegreeOptions(); merged[lvl] = merged[lvl] || []; merged[lvl].push(txt); custom[lvl] = merged[lvl]; saveCustomOptions(custom);
  // æ–°å¢æ™‚çµ¦äºˆé è¨­èƒ½åŠ›ï¼ˆä¸­ï¼‰
  const amap = getAbilityMap(); amap[lvl] = amap[lvl] || {}; amap[lvl][txt] = 'ä¸­'; saveAbilityMap(amap);
  $('newDegree').value = '';
  loadDegreeList(); loadDegreeOptions();
};

// ---------- tabs ----------
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const tab = t.dataset.tab;
    $('generatorTab').style.display = tab === 'generator' ? 'block' : 'none';
    $('editorTab').style.display = tab === 'editor' ? 'block' : 'none';
    $('practiceTab').style.display = tab === 'practice' ? 'block' : 'none';
    $('needTab').style.display = tab === 'need' ? 'block' : 'none';
    $('helpTab').style.display = tab === 'help' ? 'block' : 'none';
    if(tab === 'editor') loadDegreeList();
    if(tab === 'practice') loadPracticeList();
    if(tab === 'need') loadNeedList();
  };
});

// ---------- events ----------
$('level').addEventListener('change', ()=>{ loadDegreeOptions(); toggleSkillsDisplay(); });
$('editLevel').addEventListener('change', loadDegreeList);
// ç•¶èƒ½åŠ›æ”¹è®Šæ™‚ï¼Œé‡æ–°è¼‰å…¥ç¨‹åº¦é¸å–®ä»¥é€²è¡Œéæ¿¾
if(document.getElementById('levelState')){
  document.getElementById('levelState').addEventListener('change', ()=>{ loadDegreeOptions(); });
}
// é¸æ“‡ç¨‹åº¦æ™‚ï¼ŒåŒæ­¥èƒ½åŠ›é¸å–®ï¼ˆè‹¥è©²è©æ¢æœ‰å°æ‡‰èƒ½åŠ›ï¼‰
if(document.getElementById('degreeSelect')){
  document.getElementById('degreeSelect').addEventListener('change', ()=>{
    const lvl = $('level') ? $('level').value : '';
    const val = $('degreeSelect') ? $('degreeSelect').value : '';
    if(lvl && val){
      const ab = getAbilityFor(lvl, val);
      if(ab) {
        $('levelState').value = ab;
        // å› ç‚ºç¨‹å¼æœƒåœ¨ degree change æ™‚è‡ªå‹•è¨­å®šèƒ½åŠ›ï¼Œéœ€ç«‹å³æ›´æ–°é è¦½
        try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
      }
    }
  });
}

// åˆ‡æ›å¿…è¦æŠ€èƒ½ / æ ¸å¿ƒæŠ€èƒ½ é¡¯ç¤ºï¼šç­‰ç´š 1-4 é¡¯ç¤ºå¿…è¦æŠ€èƒ½ï¼›ç­‰ç´š 7 é¡¯ç¤ºæ ¸å¿ƒæŠ€èƒ½ï¼›å…¶ä»–éš±è—
function toggleSkillsDisplay(){
  const lvl = $('level') ? $('level').value : '';
  const req = document.getElementById('requiredSkills');
  const core = document.getElementById('coreSkills');
  const lbl = document.getElementById('skillsLabel');
  const btnAll = document.getElementById('toggleRequiredAllBtn'); // æ–°å¢ï¼šå–å¾—ã€Œæ¸…é™¤ã€æŒ‰éˆ•
  if(!req || !core || !lbl) return;

  if(['1','2','3','4'].includes(lvl)){
    lbl.textContent = 'å¿…è¦æŠ€èƒ½';
    lbl.style.display = 'block';
    req.style.display = 'block';
    // é¡¯ç¤ºæ‰€æœ‰æ¬„ä½
    adjustRequiredColumns('all');
    core.style.display = 'none';
    if(btnAll) btnAll.style.display = ''; // é¡¯ç¤ºæŒ‰éˆ•ï¼ˆæ¢å¾©åŸå§‹é¡¯ç¤ºï¼‰
  } else if(lvl === '5'){
    // ç­‰ç´š5ï¼šé¡¯ç¤ºã€Œå¿…è¦æŠ€èƒ½ã€ä½†åƒ…é¡¯ç¤ºå››ç´šæ¬„ä½
    lbl.textContent = 'å¿…è¦æŠ€èƒ½';
    lbl.style.display = 'block';
    req.style.display = 'block';
    adjustRequiredColumns('four');
    core.style.display = 'none';
    if(btnAll) btnAll.style.display = ''; // é¡¯ç¤ºæŒ‰éˆ•
  } else if(lvl === '7'){
    lbl.textContent = 'æ ¸å¿ƒæŠ€èƒ½';
    lbl.style.display = 'block';
    req.style.display = 'none';
    core.style.display = 'block';
    if(btnAll) btnAll.style.display = 'none'; // ç­‰ç´š7 éš±è—æ¸…é™¤æŒ‰éˆ•
  } else {
    lbl.style.display = 'none';
    req.style.display = 'none';
    core.style.display = 'none';
    if(btnAll) btnAll.style.display = 'none'; // é è¨­æˆ–å…¶ä»–ç­‰ç´šéš±è—æŒ‰éˆ•
  }

  // é¡¯ç¤ºåè…³å‹¾é¸ï¼šåªåœ¨ç­‰ç´š 4-7 é¡¯ç¤º
  const revWrap = document.getElementById('reverseFootWrap');
  if(revWrap) revWrap.style.display = ['4','5','6','7'].includes(lvl) ? '' : 'none';

  // æ ¹æ“šéœ€æ±‚ï¼šç­‰ç´š1-3 éš±è—ã€Œç›´æ¿å‡ºç•Œã€é¸é …ï¼›ç­‰ç´š4 åƒ…é¡¯ç¤ºã€Œç›´æ¿å‡ºç•Œã€å…¶é¤˜å¿…è¦æŠ€èƒ½éš±è—ï¼›å…¶ä»–ç­‰ç´šé‚„åŸé è¨­é¡¯ç¤º
  try{
    const remarks = Array.from(document.querySelectorAll('#requiredSkills .remark')).filter(r=>r.tagName==='INPUT');
    remarks.forEach(r=>{
      const lab = r.closest('label'); if(!lab) return;
      if(lvl === '4'){
        // åªç•™ç›´æ¿å‡ºç•Œ
        lab.style.display = (r.value === 'ç›´æ¿å‡ºç•Œ') ? '' : 'none';
      } else if(['1','2','3'].includes(lvl)){
        // éš±è—ç›´æ¿å‡ºç•Œ
        lab.style.display = (r.value === 'ç›´æ¿å‡ºç•Œ') ? 'none' : '';
      } else {
        // å…¶ä»–ç­‰ç´šé‚„åŸé¡¯ç¤ºï¼ˆç”±æ¬„ä½å¯è¦‹æ€§æ§åˆ¶ï¼‰
        lab.style.display = '';
      }
    });
  }catch(e){}
}

// èª¿æ•´å¿…è¦æŠ€èƒ½è¡¨æ ¼çš„å¯è¦‹æ¬„ä½
function adjustRequiredColumns(mode){
  const table = document.querySelector('#requiredSkills table');
  if(!table) return;
  const ths = table.querySelectorAll('thead th');
  const tds = table.querySelectorAll('tbody tr');
  if(mode === 'all'){
    ths.forEach(th=> th.style.display = '');
    tds.forEach(tr=> Array.from(tr.children).forEach(td=> td.style.display = ''));
  } else if(mode === 'four'){
    // éš±è—ç¬¬ä¸€ã€ç¬¬äºŒæ¬„ï¼Œä»…é¡¯ç¤ºç¬¬ä¸‰ï¼ˆå››ç´šï¼‰
    ths.forEach((th,i)=> th.style.display = (i===2 ? '' : 'none'));
    tds.forEach(tr=> Array.from(tr.children).forEach((td,i)=> td.style.display = (i===2 ? '' : 'none')));
  }
}

// ---------- export / import ----------
$('exportBtn').onclick = ()=>{ const data = getCustomOptions(); const blob = new Blob([JSON.stringify(data)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'degreeOptions.json'; a.click(); };
$('importBtn').onclick = ()=>{ const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json'; input.onchange = ()=>{ const f = input.files[0]; const r = new FileReader(); r.onload = ()=>{ try{ const parsed = JSON.parse(r.result); saveCustomOptions(parsed); // initialize ability map for imported data
        try{ for(const lv in parsed){ ensureAbilityMapForLevel(lv, parsed[lv] || []); } }catch(e){}
        loadDegreeList(); loadDegreeOptions(); alert('åŒ¯å…¥æˆåŠŸ'); }catch(e){ alert('æ ¼å¼éŒ¯èª¤'); } }; r.readAsText(f); }; input.click(); };

// ---------- reset to default (clear custom) ----------
$('resetDefaultBtn').onclick = ()=>{
  if(!confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­ï¼Ÿæ­¤å‹•ä½œæœƒåˆªé™¤è‡ªè¨‚è³‡æ–™')) return;
  localStorage.removeItem('customDegreeOptions');
  const custom = {};
  for(const lvl in defaultDegreeOptions) custom[lvl] = [...defaultDegreeOptions[lvl]];
  saveCustomOptions(custom);
  // åˆå§‹åŒ– ability map
  for(const lv in custom){ try{ ensureAbilityMapForLevel(lv, custom[lv] || []); }catch(e){} }
  loadDegreeList();
  loadDegreeOptions();
  alert('å·²é‡ç½®ç‚ºé è¨­');
};

// ---------- ability export / import / defaults ----------
$('exportAbilityBtn').onclick = ()=>{
  try{
    const data = getAbilityMap() || {};
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'abilityMap.json'; a.click();
  }catch(e){ alert('åŒ¯å‡ºå¤±æ•—'); }
};

$('importAbilityBtn').onclick = ()=>{
  const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json'; input.onchange = ()=>{
    const f = input.files[0]; const r = new FileReader(); r.onload = ()=>{
      try{
        const parsed = JSON.parse(r.result);
        // validate basic shape: object of levels -> object
        if(typeof parsed !== 'object' || Array.isArray(parsed)) throw new Error('æ ¼å¼ä¸æ­£ç¢º');
        saveAbilityMap(parsed);
        // ensure mapping aligns with current degree lists
        try{ const all = getDegreeOptions(); for(const lv in all){ ensureAbilityMapForLevel(lv, all[lv] || []); } }catch(e){}
        loadDegreeList(); loadDegreeOptions(); alert('èƒ½åŠ›åŒ¯å…¥æˆåŠŸ');
      }catch(e){ alert('åŒ¯å…¥å¤±æ•—ï¼šæ ¼å¼éŒ¯èª¤'); }
    };
    r.readAsText(f);
  };
  input.click();
};

$('setAbilityDefaultBtn').onclick = ()=>{
  if(!confirm('å°‡ç›®å‰èƒ½åŠ›è¨­å®šå„²å­˜ç‚ºé è¨­ï¼Ÿ')) return;
  try{ const cur = getAbilityMap(); localStorage.setItem('defaultDegreeAbilityMap_v1', JSON.stringify(cur)); alert('å·²å„²å­˜ç‚ºèƒ½åŠ›é è¨­'); }catch(e){ alert('å„²å­˜å¤±æ•—'); }
};

$('restoreAbilityDefaultBtn').onclick = ()=>{
  const s = localStorage.getItem('defaultDegreeAbilityMap_v1');
  if(!s) return alert('å°šç„¡èƒ½åŠ›é è¨­å¯é‚„åŸ');
  if(!confirm('ç¢ºå®šè¦ç”¨å·²å„²å­˜çš„èƒ½åŠ›é è¨­è¦†è“‹ç›®å‰è¨­å®šï¼Ÿ')) return;
  try{ localStorage.setItem('degreeAbilityMap_v1', s); loadDegreeList(); loadDegreeOptions(); alert('å·²é‚„åŸèƒ½åŠ›é è¨­'); }catch(e){ alert('é‚„åŸå¤±æ•—'); }
};

// ---------- Google Sheet sync (CSV) ----------
function columnLetterToIndex(col){ let idx=0; for(let i=0;i<col.length;i++){ idx = idx*26 + (col.charCodeAt(i)-64); } return idx; }
function parseCSV(text){ const rows = text.split(/\r?\n/).map(r=>r.replace(/\uFEFF/g,'')).filter((r,i)=> !(r.trim()==='' && i>10000)); return rows.map(r=>{
  // simple CSV split (handles commas inside quotes)
  const arr=[]; let cur=''; let inQ=false; for(let i=0;i<r.length;i++){ const ch=r[i]; if(ch==='"'){ if(inQ && r[i+1]==='"'){ cur+='"'; i++; } else inQ=!inQ; } else if(ch===',' && !inQ){ arr.push(cur); cur=''; } else cur+=ch; } arr.push(cur); return arr; }); }

function parseA1Range(range){ // e.g. B2:B10 or C2:C10
  const parts = range.split(':'); const a=parts[0]; const b=parts[1]||parts[0];
  const m1 = a.match(/^([A-Z]+)(\d+)$/i); const m2 = b.match(/^([A-Z]+)(\d+)$/i);
  if(!m1||!m2) return null; const c1 = m1[1].toUpperCase(), r1 = parseInt(m1[2],10); const c2 = m2[1].toUpperCase(), r2 = parseInt(m2[2],10);
  return {startCol:columnLetterToIndex(c1), endCol:columnLetterToIndex(c2), startRow:r1, endRow:r2};
}

function getCell(grid, colIdx, rowIdx){ // colIdx and rowIdx are 1-based
  if(!grid[rowIdx-1]) return ''; const row = grid[rowIdx-1]; return row[colIdx-1] || '';
}

function applySheetMappingsFromCSV(sheetCsvText){
  const grid = parseCSV(sheetCsvText);
  // mapping rules provided by user
  const mappingRules = [
    {range:'B2:B10', level:'1', ability:'åˆ'},
    {range:'C2:C10', level:'2', ability:'åˆ'},
    {range:'D2:D10', level:'3', ability:'åˆ'},
    {range:'E2:E10', level:'4', ability:'åˆ'},
    {range:'F2:F10', level:'5', ability:'åˆ'},
    {range:'G2:G10', level:'6', ability:'åˆ'},

    {range:'B11:B20', level:'1', ability:'ä¸­'},
    {range:'C11:C20', level:'2', ability:'ä¸­'},
    {range:'D11:D20', level:'3', ability:'ä¸­'},
    {range:'E11:E20', level:'4', ability:'ä¸­'},
    {range:'F11:F20', level:'5', ability:'ä¸­'},
    {range:'G11:G20', level:'6', ability:'ä¸­'},

    {range:'B21:B30', level:'1', ability:'é«˜'},
    {range:'C21:C30', level:'2', ability:'é«˜'},
    {range:'D21:D30', level:'3', ability:'é«˜'},
    {range:'E21:E30', level:'4', ability:'é«˜'},
    {range:'F21:F30', level:'5', ability:'é«˜'},
    {range:'G21:G30', level:'6', ability:'é«˜'}
    
  ];

  const result = {};
  const abilityMap = getAbilityMap();
  mappingRules.forEach(rule=>{
    const r = parseA1Range(rule.range);
    if(!r) return;
    for(let rr=r.startRow; rr<=r.endRow; rr++){
      for(let cc=r.startCol; cc<=r.endCol; cc++){
        const val = (getCell(grid, cc, rr) || '').toString().trim();
        if(!val) continue;
        result[rule.level] = result[rule.level] || [];
        result[rule.level].push({t: val, a: rule.ability});
        abilityMap[rule.level] = abilityMap[rule.level] || {};
        abilityMap[rule.level][val] = rule.ability;
      }
    }
  });

  // write to storage: customDegreeOptions and ability map
  const custom = getCustomOptions();
  for(const lv in result){ custom[lv] = result[lv].map(x=>x.t); }
  saveCustomOptions(custom);
  saveAbilityMap(abilityMap);
  // reload UI
  loadDegreeList(); loadDegreeOptions();
  /*alert('å·²å¾ Google Sheet åŒæ­¥å®Œæˆï¼ˆä½¿ç”¨é è¨­ç¯„åœè¦å‰‡ï¼‰');*/
}

function fetchSheetCsv(sheetId, gid){ const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`; return fetch(url).then(r=>{ if(!r.ok) throw new Error('fetch failed'); return r.text(); }); }

document.getElementById('syncSheetBtn').addEventListener('click', ()=>{
  const sid = document.getElementById('sheetIdInput').value.trim(); const gid = document.getElementById('sheetGidInput').value.trim() || '0'; if(!sid) return alert('è«‹è¼¸å…¥ sheet id');
  fetchSheetCsv(sid, gid).then(txt=> applySheetMappingsFromCSV(txt)).catch(e=>{ console.error(e); alert('ç„¡æ³•è®€å– Google Sheetï¼Œè«‹ç¢ºèªæ¬Šé™èˆ‡ ID/gid'); });
});

// ---------- tri-state checkbox init (ä¿ç•™ç¾æœ‰é‚è¼¯) ----------
let activeRemark = null;
const $selectedRemarkName = () => document.getElementById('selectedRemarkName');
const $selectedRemarkState = () => document.getElementById('selectedRemarkState');
function updateRemarkControlUI(){
  const nameEl = $selectedRemarkName();
  const stateEl = $selectedRemarkState();
  if(!activeRemark){
    if(nameEl) nameEl.textContent = 'ï¼ˆå°šæœªé¸å–ï¼‰';
    if(stateEl) stateEl.textContent = 'ç›®å‰ç‹€æ…‹ï¼šæœªå‹¾é¸';
    return;
  }
  const raw = activeRemark.value || '';
  if(nameEl) nameEl.textContent = raw;
  const st = activeRemark.dataset.state || (activeRemark.checked ? 'yes' : 'no');
  if(stateEl) stateEl.textContent = 'ç›®å‰ç‹€æ…‹ï¼š' + (st === 'yes' ? 'å·²å‹¾é¸ (checked)' : (st === 'half' ? 'ä¸ç¢ºå®š (indeterminate)' : 'æœªå‹¾é¸ (unchecked)'));
}

function setRemarkStateFor(el, state){
  if(!el) return;
  if(state === 'yes'){ el.checked = true; el.indeterminate = false; el.dataset.state = 'yes'; }
  else if(state === 'half'){ el.checked = false; el.indeterminate = true; el.dataset.state = 'half'; }
  else { el.checked = false; el.indeterminate = false; el.dataset.state = 'no'; }
  if(activeRemark === el) updateRemarkControlUI();
  // è®Šæ›´å¿…è¦æŠ€èƒ½ç‹€æ…‹æ™‚ç«‹å³æ›´æ–°è©•èªé è¦½
  try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
  // Update visual symbol (if label contains .remark-symbol)
  try{
    const lab = el.closest('label');
    if(lab){
      const sym = lab.querySelector('.remark-symbol');
      if(sym){
        const col = (el.closest && el.closest('td')) ? Array.from(el.closest('td').parentElement.children).indexOf(el.closest('td')) : 0;
        const mapPerCol = [
          { no:'X', yes:'O', half:'ï¼Ÿ' }, // col 0 = ä¸€ç´š
          { no:'X', yes:'O', half:'â–²' }, // col 1 = ä¸‰ç´š
          { no:'X', yes:'O', half:'' }   // col 2 = å››ç´š (no half)
        ];
        const m = mapPerCol[col] || mapPerCol[0];
        const display = m[el.dataset.state || 'no'] || '';
        sym.textContent = display;
        // update classes so CSS controls color
        sym.classList.remove('yes','half','no');
        if(el.dataset.state === 'yes') sym.classList.add('yes');
        else if(el.dataset.state === 'half') sym.classList.add('half');
        else sym.classList.add('no');
        // clear any inline style overrides to avoid stale colors
        sym.style.color = '';
        sym.style.backgroundColor = '';
        sym.style.borderColor = '';
        // if element has its own applyVisual function, call it to keep behavior consistent
        try{ if(typeof el._remark_applyVisual === 'function') el._remark_applyVisual(el.dataset.state || 'no'); }catch(e){}
      }
    }
  }catch(e){}
}

function initTriStateRemarks(){
  document.querySelectorAll('.remark').forEach(r=>{
    if(r.tagName !== 'INPUT') return;
    const isTri = r.dataset.tristate === 'true' || r.dataset.tristate === '1';
    r.tabIndex = 0;
    if(!r.dataset.state) r.dataset.state = r.checked ? 'yes' : 'no';

    // create or ensure a symbol element inside the label, before the label text
    const parentLabel = r.closest('label') || r.parentElement;
    if(parentLabel){
      // hide native checkbox visually but keep it accessible
      r.style.position = 'absolute';
      r.style.left = '-9999px';
      r.style.width = '1px';
      r.style.height = '1px';
      r.style.opacity = '0';

      // ensure .remark-symbol exists
      let sym = parentLabel.querySelector('.remark-symbol');
      if(!sym){
        sym = document.createElement('span');
        sym.className = 'remark-symbol';
        sym.style.display = 'inline-block';
        sym.style.minWidth = '20px';
        sym.style.textAlign = 'center';
        sym.style.marginRight = '6px';
        sym.style.fontWeight = '700';
        sym.style.color = '#333';
        parentLabel.insertBefore(sym, parentLabel.firstChild);
      }

      // determine column index (td child index) to choose symbol mapping
      const td = r.closest('td');
      const colIndex = td ? Array.from(td.parentElement.children).indexOf(td) : 0;

      // symbol mapping per column
      const mapPerCol = [
        { no:'X', yes:'O', half:'ï¼Ÿ' }, // ç¬¬ä¸€æ¬„ï¼ˆã€Œä¸€ç´šã€ï¼‰
        { no:'X', yes:'O', half:'â–²' }, // ç¬¬äºŒæ¬„ï¼ˆã€Œä¸‰ç´šã€ï¼‰
        { no:'X', yes:'O', half:'' }   // ç¬¬ä¸‰æ¬„ï¼ˆã€Œå››ç´šã€ï¼Œç„¡ halfï¼‰
      ];
      const map = mapPerCol[colIndex] || mapPerCol[0];

      // apply visual based on current dataset.state
      // Use classes (.yes/.half/.no) for color/background so CSS handles visuals
      const applyVisual = (state)=>{
        sym.textContent = map[state] || map['no'] || '';
        sym.classList.remove('yes','half','no');
        if(state === 'yes') sym.classList.add('yes');
        else if(state === 'half') sym.classList.add('half');
        else sym.classList.add('no');
        // clear any inline color/background overrides
        sym.style.color = '';
        sym.style.backgroundColor = '';
        sym.style.borderColor = '';
      };

      // apply initial visual
      applyVisual(r.dataset.state || (r.checked ? 'yes' : 'no'));

      // store per-element cycle behavior
      r._remark_cycle = map; // keep mapping for other handlers
      r._remark_colIndex = colIndex;
      r._remark_applyVisual = applyVisual;
    }

    const updateApplyState = (s)=>{
      // synchronize dataset/state/checked/indeterminate and visual
      if(isTri){
        if(s === 'yes'){ r.checked = true; r.indeterminate = false; r.dataset.state = 'yes'; }
        else if(s === 'half'){ r.checked = false; r.indeterminate = true; r.dataset.state = 'half'; }
        else { r.checked = false; r.indeterminate = false; r.dataset.state = 'no'; }
      } else {
        if(s === 'yes'){ r.checked = true; r.indeterminate = false; r.dataset.state = 'yes'; }
        else { r.checked = false; r.indeterminate = false; r.dataset.state = 'no'; }
      }
      // update symbol visual if present
      try{ if(typeof r._remark_applyVisual === 'function') r._remark_applyVisual(r.dataset.state || (r.checked ? 'yes' : 'no')); }catch(e){}
      // trigger preview update if existing
      try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
    };

    // default apply current dataset state visually
    updateApplyState(r.dataset.state || (r.checked ? 'yes' : 'no'));

    // determine cycle for this element based on column and tri-state support
    let cycle;
    try{
      const col = r._remark_colIndex || 0;
      if(col === 0){ cycle = ['no','yes','half']; } // ä¸€ç´š: X -> O -> ï¼Ÿ
      else if(col === 1){ cycle = ['no','yes','half']; } // ä¸‰ç´š: X -> O -> â–²
      else { cycle = ['no','yes']; } // å››ç´š: X <-> O
    }catch(e){ cycle = isTri ? ['no','yes','half'] : ['no','yes']; }

    // bind click to cycle states
    parentLabel && parentLabel.addEventListener && parentLabel.addEventListener('click', (e)=>{
      e.preventDefault();
      const cur = r.dataset.state || (r.checked ? 'yes' : 'no');
      const idx = cycle.indexOf(cur);
      const next = cycle[(idx + 1) % cycle.length];
      updateApplyState(next);
    });

    // make keyboard accessible: space/enter also cycle
    r.addEventListener('keydown', (e)=>{
      if(e.key === ' ' || e.key === 'Spacebar' || e.key === 'Enter'){
        e.preventDefault();
        const cur = r.dataset.state || (r.checked ? 'yes' : 'no');
        const idx = cycle.indexOf(cur);
        const next = cycle[(idx + 1) % cycle.length];
        updateApplyState(next);
      }
    });

    // keep focus behavior (for control panel)
    r.addEventListener('focus', ()=>{ activeRemark = r; updateRemarkControlUI(); });

  });

  // setup small control buttons if exist (ä¿æŒåŸé‚è¼¯)
  const setupControls = ()=>{
    const btnU = document.getElementById('setUnchecked');
    const btnC = document.getElementById('setChecked');
    const btnH = document.getElementById('setIndet');
    if(btnU) btnU.onclick = ()=>{ if(activeRemark) setRemarkStateFor(activeRemark, 'no'); else alert('è«‹å…ˆé»é¸ä¸€å€‹å¿…è¦æŠ€èƒ½'); };
    if(btnC) btnC.onclick = ()=>{ if(activeRemark) setRemarkStateFor(activeRemark, 'yes'); else alert('è«‹å…ˆé»é¸ä¸€å€‹å¿…è¦æŠ€èƒ½'); };
    if(btnH) btnH.onclick = ()=>{ if(!activeRemark) return alert('è«‹å…ˆé»é¸ä¸€å€‹å¿…è¦æŠ€èƒ½'); const isTri = activeRemark.dataset.tristate === 'true' || activeRemark.dataset.tristate === '1'; if(!isTri) return alert('æ­¤é …ä¸æ”¯æ´ã€Œä¸ç¢ºå®šã€ç‹€æ…‹'); setRemarkStateFor(activeRemark, 'half'); };
  };
  setupControls();
  updateRemarkControlUI();
}

// åœ¨ initTriStateRemarks() å®šç¾©å¾ŒåŠ å…¥ä»¥ä¸‹å‡½å¼èˆ‡ç¶å®šï¼ˆå·²ä¿®æ­£åˆ¤æ–·é‚è¼¯ï¼Œé¿å…åªæœƒå–æ¶ˆå‹¾é¸çš„å•é¡Œï¼‰
function toggleAllRequired(){
  // æ¸…é™¤æ‰€æœ‰å¿…è¦æŠ€èƒ½ï¼ˆå°‡æ‰€æœ‰ input.remark è¨­ç‚ºæœªå‹¾é¸ï¼‰
  const remarks = Array.from(document.querySelectorAll('#requiredSkills .remark')).filter(r => r.tagName === 'INPUT');
  if(!remarks.length) return;
  remarks.forEach(r => setRemarkStateFor(r, 'no'));
}

function toggleColumn1(){
  // å‹¾é¸ä¸€ç´šæ¬„ä½å…§æ‰€æœ‰é …ç›®ï¼ˆåƒ…è™•ç†ç¬¬ä¸€æ¬„çš„ input.remarkï¼‰
  const elems = Array.from(document.querySelectorAll('#requiredSkills tbody tr td:nth-child(1) .remark')).filter(r => r.tagName === 'INPUT');
  if(!elems.length) return;
  elems.forEach(r => setRemarkStateFor(r, 'yes'));
}

// ç¶å®šæŒ‰éˆ•ï¼ˆåœ¨ DOM ready / load æ™‚æœƒç¶å®šï¼Œé€™é‚Šä¿éšªæ”¾åœ¨ window load åˆå§‹åŒ–æ®µè½ï¼‰
window.addEventListener('load', ()=>{
  const sheetId = '1kx9lS69H_ldkeKt3Nww_k65z8IMcRgTlm86uFJtdViA';
  const sheetGid = '0';

  const continueInit = ()=>{
    const custom = getCustomOptions();
    let changed = false;
    for(const lvl in defaultDegreeOptions){
      if(!custom[lvl] || !Array.isArray(custom[lvl]) || custom[lvl].length === 0){
        custom[lvl] = [...defaultDegreeOptions[lvl]];
        changed = true;
      }
    }
    if(changed) saveCustomOptions(custom);

    // åˆå§‹åŒ– ability map èˆ‡ç¾æœ‰ custom æ¸…å–®å°é½Š
    for(const lv in custom){ try{ ensureAbilityMapForLevel(lv, custom[lv] || []); }catch(e){} }

    loadDegreeOptions();
    // Editor is hidden; do not call loadDegreeList() to avoid unnecessary operations
    ensurePracticeTemplatesInitialized();

    // ===== æ–°ï¼šå„ªé›…è™•ç† Firebase èˆ‡æœ¬æ©Ÿ templates çš„åˆå§‹åŒ–èˆ‡åŒæ­¥ =====
    try{
      if(window.maDb){
        // å…ˆå˜—è©¦ä¸€æ¬¡æ€§å¾ Firebase è®€å– practice / needï¼Œé¿å…åœ¨æœ¬æ©Ÿç©ºç™½æ™‚è¦†å¯«é ç«¯
        Promise.all([firebaseRead('practiceTemplates_v1'), firebaseRead('needTemplates_v1')])
        .then(([pData, nData])=>{
          // å„ªå…ˆä½¿ç”¨é ç«¯è³‡æ–™ï¼›è‹¥é ç«¯ç‚ºç©ºä½†æœ¬æ©Ÿå·²æœ‰è³‡æ–™ï¼Œå‰‡ä»¥æœ¬æ©Ÿç‚ºä¾†æºå¯«å›é ç«¯ï¼›è‹¥å…©è€…çš†ç„¡ï¼Œå‰‡ä¸ä½¿ç”¨å…§å»ºé è¨­ä»¥é¿å…è¦†å¯«é ç«¯
          const localP = getPracticeTemplates();
          if(pData && typeof pData === 'object' && Object.keys(pData).length){
            savePracticeTemplates(pData);
          } else if(localP && typeof localP === 'object' && Object.keys(localP).length){
            // push local -> remote
            savePracticeTemplates(localP);
          } else {
            // leave local empty (do not write built-in defaults)
            try{ if(!localP || typeof localP !== 'object') localStorage.setItem('practiceTemplates_v1', JSON.stringify({})); }catch(e){}
          }

          const localN = getNeedTemplates();
          if(nData && typeof nData === 'object' && Object.keys(nData).length){
            saveNeedTemplates(nData);
          } else if(localN && typeof localN === 'object' && Object.keys(localN).length){
            saveNeedTemplates(localN);
          } else {
            try{ if(!localN || typeof localN !== 'object') localStorage.setItem('needTemplates_v1', JSON.stringify({})); }catch(e){}
          }

          // render UI
          loadPracticeList(); renderPracticeQuickButtons();
          loadNeedList(); renderNeedQuickButtons();
        })
        .catch((err)=>{
          console.warn('firebaseRead failed, fallback to local', err);
          // fallback: ä½¿ç”¨æœ¬æ©Ÿåˆå§‹åŒ–å‡½å¼ï¼ˆä¿æŒèˆŠé‚è¼¯ï¼‰
          ensurePracticeTemplatesInitialized();
          ensureNeedTemplatesInitialized();
          loadPracticeList(); renderPracticeQuickButtons();
          loadNeedList(); renderNeedQuickButtons();
        });

        // ä¿ç•™ realtime listenerï¼ˆè‹¥é ç«¯å¾ŒçºŒæœ‰è®Šæ›´æœƒè‡ªå‹•æ›´æ–°æœ¬æ©Ÿèˆ‡ UIï¼‰
        try{ window.maDb.ref('practiceTemplates_v1').on('value', snap=>{ const v = snap.val(); if(v){ savePracticeTemplates(v); loadPracticeList(); renderPracticeQuickButtons(); } }); }catch(e){}
        try{ window.maDb.ref('needTemplates_v1').on('value', snap=>{ const v = snap.val(); if(v){ saveNeedTemplates(v); loadNeedList(); renderNeedQuickButtons(); } }); }catch(e){}
      } else {
        // ç„¡ Firebaseï¼šä½¿ç”¨æœ¬åœ°åˆå§‹åŒ–ï¼ˆåŸæœ¬è¡Œç‚ºï¼‰
        ensurePracticeTemplatesInitialized();
        ensureNeedTemplatesInitialized();
        loadPracticeList(); renderPracticeQuickButtons();
        loadNeedList(); renderNeedQuickButtons();
      }
    }catch(e){ console.warn('firebase sync error', e); ensurePracticeTemplatesInitialized(); ensureNeedTemplatesInitialized(); loadPracticeList(); renderPracticeQuickButtons(); loadNeedList(); renderNeedQuickButtons(); }
    // ===== end sync logic =====

    initTriStateRemarks();
    toggleSkillsDisplay();

    // ç¶å®šæ–°å¢çš„æŒ‰éˆ•ï¼ˆè‹¥å­˜åœ¨ï¼‰
    // éš±è—åŒ¯å‡º/åŒ¯å…¥/é‡ç½®æŒ‰éˆ•ï¼ˆç”±ä½¿ç”¨è€…è«‹æ±‚ï¼‰
    ['exportBtn','importBtn','resetDefaultBtn','exportPracticeBtn','importPracticeBtn','resetPracticeBtn','exportNeedBtn','importNeedBtn','resetNeedBtn'].forEach(id=>{ const el = document.getElementById(id); if(el) el.style.display = 'none'; });
    const btnAll = document.getElementById('toggleRequiredAllBtn');
    if(btnAll) btnAll.addEventListener('click', (e)=>{ e.preventDefault(); toggleAllRequired(); });

    const btnL1 = document.getElementById('toggleLevel1Btn');
    if(btnL1) btnL1.addEventListener('click', (e)=>{ e.preventDefault(); toggleColumn1(); });

    // ç¶å®šï¼šæ ¸å¿ƒæŠ€èƒ½ã€Œæ¢å¾©é è¨­ã€æŒ‰éˆ•ï¼ˆå°‡æ‰€æœ‰æ¬„ä½è¨­ç‚º 'I'ï¼‰
    const restoreCoreBtn = document.getElementById('restoreCoreDefaultsBtn');
    if(restoreCoreBtn){
      restoreCoreBtn.addEventListener('click', (e)=>{
        e.preventDefault();
        const cols = document.querySelectorAll('#skillBlockCore .skill-col');
        if(!cols || cols.length === 0) return;
        const arr = Array.from(cols).map(()=> 'I');
        applyCoreStateArray(arr);
        showToast('æ ¸å¿ƒæŠ€èƒ½å·²æ¢å¾©é è¨­ (I)');
      });
    }
  };

  // å…ˆå˜—è©¦è‡ªå‹•å¾ Google Sheet æŠ“å–ä¸¦å¥—ç”¨ï¼›å¤±æ•—å‰‡é€€å›åŸæœ¬ localStorage/default åˆå§‹åŒ–
  fetchSheetCsv(sheetId, sheetGid).then(txt=>{
    try{ applySheetMappingsFromCSV(txt); }catch(e){ console.warn('apply sheet failed', e); }
  }).catch(e=>{
    console.warn('fetch sheet failed, fallback to local defaults', e);
  }).finally(()=>{
    continueInit();
  });
});

// ---------- generate remark output (éµå¾ªç­‰ç´šè¦å‰‡) ----------
// è¦å‰‡ï¼š1-4 åŒ…å«å¿…è¦æŠ€èƒ½ï¼›5-6 ä¸åŒ…å«å¿…è¦æŠ€èƒ½ï¼›7 åŒ…å«æ ¸å¿ƒæŠ€èƒ½ï¼ˆä¸åŒ…å«å¿…è¦æŠ€èƒ½ï¼‰
function generatePreview(){
  const level = $('level') ? $('level').value.trim() : '';
  const rating = $('rating') ? $('rating').value.trim() : '';
  // æ”¹ç‚º levelStateRaw é¿å…èˆ‡å¾Œé¢ let state è¡çª
  const levelStateRaw = $('levelState') ? $('levelState').value.trim() : '';
  const type = $('type') ? $('type').value.trim() : '';
  const char = $('character') ? $('character').value.trim() : '';
  const degree = $('degreeSelect') ? $('degreeSelect').value.trim() : '';
  const need = $('needImprove') ? $('needImprove').value.trim() : '';
  const practice = $('practice') ? $('practice').value.trim() : '';
  const otherNotes = $('otherNotes') ? $('otherNotes').value.trim() : '';
  const reverseFootChecked = $('reverseFoot') ? !!$('reverseFoot').checked : false;

  // sanitize ability displayï¼šè‹¥ levelState å…§èª¤å¸¶æ•¸å­—ï¼Œç§»é™¤å‰å°æ•¸å­—ä»¥é¿å…ç”¢ç”Ÿ "2ä¸­" å‹å¼
  let state = (levelStateRaw || '').replace(/^\d+/, '');

  if(!level || !state || !degree){
    // ä¸å½ˆå‡º alert é€ æˆæ‰“æ–·ï¼Œè‡ªå‹•è§¸ç™¼æƒ…å¢ƒåƒ…æ›´æ–° preview ç‚ºæç¤ºæ–‡å­—
    $('preview').textContent = 'è«‹é¸æ“‡ ç­‰ç´šã€èƒ½åŠ› èˆ‡ ç¨‹åº¦ï¼ˆç‚ºå¿…å¡«é …ï¼‰';
    return;
  }

  const includeRequired = ['1','2','3','4','5'].includes(level);
  const includeCore = level === '7';

  // æº–å‚™ corePartsï¼ˆä¸è«–æ˜¯å¦åŒ…å«ï¼Œéƒ½è®€å–ç›®å‰é¸é …ä»¥ä¾¿ UI é¡¯ç¤º/å„²å­˜ï¼‰
  const coreShort = ["æ","å¼·","å°","åœ˜","åœ˜å°"];
  const corePartsAll = [];
  document.querySelectorAll('#skillBlockCore .skill-col').forEach((col,i)=>{
    const a = col.querySelector('button.active');
    if(a) corePartsAll.push(coreShort[i] + a.textContent);
  });

  // æº–å‚™ required remark textsï¼ˆåƒ…ç•¶ includeRequired ç‚º true æ‰ä½¿ç”¨ï¼‰
  let remarkElems = [];
  if(includeRequired){
    if(level === '5'){
      remarkElems = Array.from(document.querySelectorAll('#requiredSkills tbody tr td:nth-child(3) .remark'));
    } else if(level === '4'){
      // level4: only consider the 'ç›´æ¿å‡ºç•Œ' checkbox
      remarkElems = Array.from(document.querySelectorAll('#requiredSkills .remark')).filter(r=>r.tagName==='INPUT' && r.value === 'ç›´æ¿å‡ºç•Œ');
    } else {
      // level1-3: exclude 'ç›´æ¿å‡ºç•Œ' from exported remarks
      remarkElems = Array.from(document.querySelectorAll('#requiredSkills .remark')).filter(r=> !(['1','2','3'].includes(level) && r.value === 'ç›´æ¿å‡ºç•Œ'));
    }
  } else {
    remarkElems = [];
  }
  const remarkTexts = remarkElems.map(r=>{
    if(r.tagName === 'INPUT'){
      const raw = r.value.trim();
      const short = remarkMap[raw] || raw;
      const st = r.dataset.state || (r.checked ? 'yes' : 'no');

      // æ ¹æ“šæ¬„ä½æ±ºå®šè¼¸å‡ºç¬¦è™Ÿï¼šç¬¬ä¸€æ¬„ç”¨ ?ã€ç¬¬äºŒæ¬„ç”¨ â–²ã€ç¬¬ä¸‰æ¬„ç„¡ half
      const td = r.closest && r.closest('td');
      const col = td ? Array.from(td.parentElement.children).indexOf(td) : 0;
      const mapPerCol = [
        { no:'X', yes:'O', half:'ï¼Ÿ' }, // col 0 = ä¸€ç´š (ä½¿ç”¨å…¨å½¢å•è™Ÿ)
        { no:'X', yes:'O', half:'â–²' }, // col 1 = ä¸‰ç´š
        { no:'X', yes:'O', half:'' }   // col 2 = å››ç´š (no half)
      ];
      const m = mapPerCol[col] || mapPerCol[0];
      const suffix = (st && m[st] !== undefined) ? m[st] : (m['no'] || '');
      return `${short}${suffix}`;
    }
    return '';
  }).filter(Boolean);

  const parts = [];
  // å°‡èƒ½åŠ›é¡¯ç¤ºæ”¹ç‚ºåŒ…å«ç­‰ç´šæ•¸å­—ï¼ˆä¾‹å¦‚ï¼š2ä¸­ï¼‰
  const abilityDisplay = `${level}${state}`;
  if(rating && rating !== 'æœªè©•ç´š'){
    parts.push(`${rating}ï¼Œ${abilityDisplay}`);
  } else {
    parts.push(abilityDisplay);
  }
  if(type) parts.push(type);
  if(char) parts.push(char);
  if(reverseFootChecked){
    if(parts.length){
      parts[0] = parts[0] + 'ï¼Œåè…³';
    } else {
      parts.push('åè…³');
    }
  }
  parts.push(`ç¨‹åº¦ï¼š${degree}`);
  // å°‡å…¶ä»–å‚™è¨»æ”¾åœ¨éœ€åŠ å¼·ä¹‹å‰
  if(otherNotes) parts.push(otherNotes);
  if(need) parts.push(`éœ€åŠ å¼·ï¼š${need}`);
  if(practice) parts.push(`å»ºè­°ç·´ç¿’ï¼š${practice}`);

  let corePrefix = '';
  if(includeCore && corePartsAll.length){
    // ç­‰ç´š7 çš„æ ¸å¿ƒæŠ€èƒ½ä»¥é “è™Ÿï¼ˆã€ï¼‰ä½œç‚ºé–“éš”
    corePrefix = corePartsAll.join('ã€');
  }
  let body = parts.join(' ///');
  if(remarkTexts.length) body += ' ///' + remarkTexts.join(' ');
  let final = body;
  if(corePrefix) final = corePrefix + (body ? ' ///' + body : '');

  $('preview').textContent = final || 'å°šæœªç”¢ç”Ÿè©•èªã€‚';
  if($('coreOutput')) $('coreOutput').textContent = corePartsAll.join('ã€');
}

// ç¶å®šåŸæœ¬æŒ‰éˆ•è¡Œç‚ºï¼ˆæŒ‰éˆ•ä»å­˜åœ¨ä½†æœƒéš±è—ï¼‰
if($('genBtn')) $('genBtn').onclick = generatePreview;

// éš±è—ç”¢ç”ŸæŒ‰éˆ•ï¼Œä½†é¡¯ç¤ºã€Œæ¸…ç©ºå…¨éƒ¨ã€æŒ‰éˆ•ä»¥æ¢å¾©åŠŸèƒ½
if($('genBtn')) $('genBtn').style.display = 'none';
if($('toggleResetRestoreBtn')) $('toggleResetRestoreBtn').style.display = '';
if($('toggleResetInputsBtn')) $('toggleResetInputsBtn').style.display = '';

// å…¨åŸŸè‡ªå‹•è§¸ç™¼ï¼šç›£è½ change/input ä»¥å³æ™‚æ›´æ–°ç”¢ç”Ÿçµæœ
document.addEventListener('change', (e)=>{
  const t = e && e.target;
  if(!t) return;
  if(t.matches && (t.matches('select') || t.matches('input') || t.matches('textarea'))){
    generatePreview();
  }
}, true);
document.addEventListener('input', (e)=>{ const t = e && e.target; if(!t) return; if(t.matches && (t.matches('textarea') || (t.matches('input') && (t.type==='text' || t.type==='search' || t.type==='tel' || t.type==='url')))) generatePreview(); }, true);

// ---------- æ¸…ç©º/æ¢å¾©ï¼ˆåˆä½µæŒ‰éˆ•ï¼‰ ----------
let isCleared = false;
let _clearedMonitorActive = false;
// --- æ–°å¢ï¼šè¼¸å…¥å°ˆç”¨æ¸…ç©º/æ¢å¾©ç‹€æ…‹èˆ‡ç›£è½å™¨ ---
let isInputsCleared = false;
let savedInputsState = {};
let _inputsMonitorActive = false;
let _inputsMonitorHandlerInput = null;

function startInputsClearedMonitor(){
  if(_inputsMonitorActive) return;

  const cancelInputsRestore = ()=>{
    if(!isInputsCleared) return;
    const ibtn = $('toggleResetInputsBtn');
    if(ibtn){
      ibtn.textContent = 'æ¸…ç©ºè¼¸å…¥';
      ibtn.classList.remove('restore'); ibtn.classList.add('clear');
    }
    savedInputsState = {};
    try{ sessionStorage.removeItem('savedInputsState_v1'); }catch(e){}
    isInputsCleared = false;
    stopInputsClearedMonitor();
  };

  // åªè¦ä½¿ç”¨è€…åœ¨ä¸‰å€‹æ–‡å­—æ¬„ä½è¼¸å…¥ï¼Œå°±å–æ¶ˆè¼¸å…¥æ¢å¾©
  _inputsMonitorHandlerInput = (e)=>{
    const t = e && e.target; if(!t) return;
    const targetIds = ['needImprove','practice','otherNotes'];
    if((t.tagName === 'TEXTAREA' || t.tagName === 'INPUT') && targetIds.includes(t.id)){
      cancelInputsRestore();
    }
  };
  document.addEventListener('input', _inputsMonitorHandlerInput, true);

  _inputsMonitorActive = true;
}

function stopInputsClearedMonitor(){
  if(!_inputsMonitorActive) return;
  if(_inputsMonitorHandlerInput){ document.removeEventListener('input', _inputsMonitorHandlerInput, true); _inputsMonitorHandlerInput = null; }
  _inputsMonitorActive = false;
}
// ç§»é™¤èˆŠå–®ä¸€ handlerï¼Œæ”¹ç‚ºä¸‰å€‹å°ˆå±¬ handler
let _clearedMonitorHandlerSelect = null;
let _clearedMonitorHandlerInput = null;
let _clearedMonitorHandlerClickSkill = null;

function startClearedMonitor(){
  if(_clearedMonitorActive) return;

  // å–æ¶ˆå¾©åŸï¼ˆrestoreï¼‰çš„å…±ç”¨è¡Œç‚º
  const cancelRestore = ()=>{
    if(!isCleared) return;
    const btn = $('toggleResetRestoreBtn');
    if(btn){
      btn.textContent = 'æ¸…ç©ºå…¨éƒ¨';
      btn.classList.remove('restore'); btn.classList.add('clear');
    }
    // æ¸…é™¤æš«å­˜ç‹€æ…‹
    savedInputState = {};
    try{ sessionStorage.removeItem('savedInputState_v1'); }catch(e){}
    isCleared = false;
    stopClearedMonitor();
  };

  // 1) ç›£è½ select çš„ changeï¼ˆä½¿ç”¨ capturing å¯æ—©ä¸€é»è™•ç†ï¼‰
  _clearedMonitorHandlerSelect = (e)=>{
    const t = e && e.target;
    if(!t) return;
    if(t.tagName === 'SELECT') cancelRestore();
  };
  document.addEventListener('change', _clearedMonitorHandlerSelect, true);

  // 2) ç›£è½æŒ‡å®šæ–‡å­—æ¬„ä½çš„ inputï¼ˆéœ€åŠ å¼· / å»ºè­°ç·´ç¿’ ä»¥åŠç·¨è¼¯é å¯èƒ½çš„è¼¸å…¥æ¬„ï¼‰
  _clearedMonitorHandlerInput = (e)=>{
    const t = e && e.target;
    if(!t) return;
    const targetIds = ['needImprove','practice','otherNotes','reverseFoot','newNeed','newPractice','newDegree'];
    if(t.tagName === 'TEXTAREA' || t.tagName === 'INPUT'){
      if(targetIds.includes(t.id)) cancelRestore();
    }
  };
  document.addEventListener('input', _clearedMonitorHandlerInput, true);

  // 3) ç›£è½å¿…è¦æŠ€èƒ½ æˆ– æ ¸å¿ƒæŠ€èƒ½ çš„é»æ“Šï¼ˆcheckbox æˆ– core skill buttonï¼‰
  _clearedMonitorHandlerClickSkill = (e)=>{
    const t = e && e.target;
    if(!t) return;
    // å¦‚æœé»æ“Šç™¼ç”Ÿåœ¨ #requiredSkills æˆ– #coreSkills / #skillBlockCore å€åŸŸå…§ï¼Œè¦–ç‚ºäº’å‹•
    if(t.closest && (t.closest('#requiredSkills') || t.closest('#coreSkills') || t.closest('#skillBlockCore'))){
      cancelRestore();
    }
    // å¦å¤–è‹¥ç›´æ¥é»åˆ° input.remark ä¹Ÿè™•ç†ï¼ˆä¿éšªï¼‰
    if(t.classList && t.classList.contains && t.classList.contains('remark')){
      cancelRestore();
    }
  };
  document.addEventListener('click', _clearedMonitorHandlerClickSkill, true);

  _clearedMonitorActive = true;
}

function stopClearedMonitor(){
  if(!_clearedMonitorActive) return;
  if(_clearedMonitorHandlerSelect) { document.removeEventListener('change', _clearedMonitorHandlerSelect, true); _clearedMonitorHandlerSelect = null; }
  if(_clearedMonitorHandlerInput) { document.removeEventListener('input', _clearedMonitorHandlerInput, true); _clearedMonitorHandlerInput = null; }
  if(_clearedMonitorHandlerClickSkill) { document.removeEventListener('click', _clearedMonitorHandlerClickSkill, true); _clearedMonitorHandlerClickSkill = null; }
  _clearedMonitorActive = false;
}

// ---------- copy with check + toast ----------
function showCopyCheck(){ const chk = $('copyCheck'); if(!chk) return; chk.style.opacity = '1'; setTimeout(()=>{ chk.style.opacity = '0'; }, 1000); }
function showToast(msg){ const t = $('toast'); if(!t) return; t.textContent = msg; t.classList.add('show'); setTimeout(()=> t.classList.remove('show'), 1000); }
$('copyBtn').onclick = ()=>{ const text = $('preview').textContent || ''; navigator.clipboard.writeText(text).then(()=>{ showCopyCheck(); showToast('å·²è¤‡è£½'); }).catch(()=>{ alert('è¤‡è£½å¤±æ•—'); }); };

/* ---------- æ ¸å¿ƒæŠ€èƒ½ï¼ˆç­‰ç´š7ï¼‰é¢æ¿ åˆå§‹åŒ–ï¼šå…©åˆ—æ’åˆ— I/IA èˆ‡ A/AC/Cï¼Œå„²å­˜/è¼‰å…¥ç‹€æ…‹ ---------- */
(function initCoreSkills(){
  const skillNames = ["ææ—©æ›åˆƒ","å¼·å£¯ç«™å§¿","å°è½‰","åœ˜èº«","åœ˜èº«å°è½‰"];
  const shortNames = ["æ","å¼·","å°","åœ˜","åœ˜å°"];
  const levels = ["I","IA","A","AC","C"];
  const container = document.getElementById('skillBlockCore');
  if(!container) return;

  container.innerHTML = '';
  skillNames.forEach((name,i)=>{
    const col = document.createElement('div');
    col.className = 'skill-col';
    col.innerHTML = `<div class="skill-name">${name}</div>`;
    const btnGroup = document.createElement('div');
    btnGroup.className = 'skill-buttons';
    const row1 = document.createElement('div'); row1.className = 'skill-row';
    const row2 = document.createElement('div'); row2.className = 'skill-row';
    // create buttons: first two in row1, rest in row2
    levels.forEach((lv, idx)=>{

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = lv;
      btn.onclick = ()=>{

        col.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        // è®Šæ›´æ™‚ä¹Ÿç«‹å³å„²å­˜åˆ° localStorage
        const st = {};
        container.querySelectorAll('.skill-col').forEach((c,j)=>{
          const s = c.querySelector('button.active');
          st[j] = s ? s.textContent : '';
        });
        localStorage.setItem('coreSkillState_v1', JSON.stringify(st));
        // ç«‹å³æ›´æ–°é è¦½ï¼ˆè‡ªå‹•ç”¢ç”Ÿï¼‰
        try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
      };
      if(idx < 2) row1.appendChild(btn);
      else row2.appendChild(btn);
    });
    btnGroup.appendChild(row1);
    btnGroup.appendChild(row2);
    col.appendChild(btnGroup);
    container.appendChild(col);
  });

  // load state
  const saved = JSON.parse(localStorage.getItem('coreSkillState_v1') || '{}');
  const arr = [];
  container.querySelectorAll('.skill-col').forEach((col,i)=>{
    arr[i] = saved[i] || '';
  });
  // è‹¥ localStorage ç„¡å€¼ï¼Œé è¨­ç‚º Iï¼ˆç¬¬ä¸€å€‹ï¼‰
  const hasAny = arr.some(v=>v && v.length);
  applyCoreStateArray(hasAny ? arr : Array(container.querySelectorAll('.skill-col').length).fill('I'));

  // ç§»é™¤èˆŠæœ‰ã€Œç”¢ç”Ÿæ ¸å¿ƒæŠ€èƒ½æ‘˜è¦ã€æŒ‰éˆ•èˆ‡ coreOutputï¼ˆè‹¥å­˜åœ¨ï¼‰ï¼Œå› ç‚ºä½ è¦åˆªæ‰é€™äº› UI
  const genCoreBtn = document.getElementById('generateCore');
  if(genCoreBtn) genCoret.remove();
  const coreOutEl = document.getElementById('coreOutput');
  if(coreOutEl) coreOutEl.remove();

})();

/* ---------- å…±ç”¨ï¼šå¥—ç”¨æ ¸å¿ƒæŠ€èƒ½ç‹€æ…‹é™£åˆ—ä¸¦å„²å­˜ ---------- */
function applyCoreStateArray(arr){
  const cols = document.querySelectorAll('#skillBlockCore .skill-col');
  if(!cols || cols.length === 0) return;
  cols.forEach((col,i)=>{
    const btns = Array.from(col.querySelectorAll('button'));
    btns.forEach(b=>b.classList.remove('active'));
    // ä¾å‚³å…¥å€¼æ‰¾æŒ‰éˆ•ï¼Œè‹¥ç„¡å‰‡é è¨­ç¬¬ä¸€å€‹ (I)
    const want = arr && typeof arr[i] === 'string' && arr[i] ? arr[i] : 'I';
    const target = btns.find(b=>b.textContent === want) || btns[0];
    if(target) target.classList.add('active');
  });
  // å„²å­˜åˆ° localStorageï¼ˆèˆ‡åŸæœ¬ saveCoreState è¡Œç‚ºä¸€è‡´ï¼‰
  const state = {};
  document.querySelectorAll('#skillBlockCore .skill-col').forEach((col,i)=>{
    const sel = col.querySelector('button.active');
    state[i] = sel ? sel.textContent : '';
  });
  localStorage.setItem('coreSkillState_v1', JSON.stringify(state));
  // è®Šæ›´æ ¸å¿ƒæŠ€èƒ½ç‹€æ…‹æ™‚ç«‹å³æ›´æ–°è©•èªé è¦½
  try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
}

// ---------- å»ºè­°ç·´ç¿’ï¼šè¼‰å…¥ / ç·¨è¼¯ / åˆªé™¤ / æ’åºï¼ˆeditor åˆ†é ä½¿ç”¨ï¼‰ ----------
function loadPracticeList(){
  ensurePracticeTemplatesInitialized();
  const lvlEl = $('editPracticeLevel');
  if(!lvlEl) return;
  const lvl = lvlEl.value || '1';
  const listEl = $('practiceList');
  if(!listEl) return;
  listEl.innerHTML = '';
  const all = getPracticeTemplates() || {};
  all[lvl] = Array.isArray(all[lvl]) ? all[lvl] : [];
  all[lvl].forEach((txt, idx)=>{
    const li = document.createElement('li');
    li.className = 'degree-item';

    const span = document.createElement('span');
    span.textContent = txt;
    span.title = 'é›™æ“Šç·¨è¼¯';

    // é›™æ“Šç·¨è¼¯
    span.addEventListener('dblclick', ()=>{
      if(li.querySelector('input')) return;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = txt;
      input.style.width = '100%';
      input.style.padding = '6px';
      input.style.borderRadius = '6px';
      input.style.border = '1px solid #ccc';
      li.replaceChild(input, span);
      input.focus();
      input.select();

      const cancel = ()=>{ if(li.contains(input)) li.replaceChild(span, input); };
      const save = ()=>{
        const v = input.value.trim();
        if(v === ''){ alert('å…§å®¹ä¸å¯ç‚ºç©º'); input.focus(); return; }
        const cur = getPracticeTemplates() || {};
        cur[lvl] = cur[lvl] || [];
        cur[lvl][idx] = v;
        savePracticeTemplates(cur);
        loadPracticeList();
        renderPracticeQuickButtons();
      };

      input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); save(); } else if(e.key === 'Escape'){ e.preventDefault(); cancel(); } });
      input.addEventListener('blur', ()=>{ if(input.value.trim() === txt) cancel(); else save(); });
    });

    const del = document.createElement('button');
    del.textContent = 'âœ•';
    del.onclick = ()=>{ if(!confirm('åˆªé™¤æ­¤ç¯„æœ¬ï¼Ÿ')) return; const cur = getPracticeTemplates() || {}; cur[lvl] = cur[lvl] || []; cur[lvl].splice(idx,1); savePracticeTemplates(cur); loadPracticeList(); renderPracticeQuickButtons(); };

    li.appendChild(span);
    li.appendChild(del);
    listEl.appendChild(li);
  });
  // æ’åºæ”¯æ´ï¼šè‹¥å·²å»ºç«‹é Sortable å‰‡å…ˆ destroy å†å»ºç«‹ï¼Œä¸¦ä½¿ç”¨ span ä½œç‚º handle é¿å…èª¤è§¸æŒ‰éˆ•
  try{
    if(listEl._sortable && typeof listEl._sortable.destroy === 'function'){
      try{ listEl._sortable.destroy(); }catch(e){}
      listEl._sortable = null;
    }
    listEl._sortable = Sortable.create(listEl, {
      animation:150,
      handle: 'span',
      draggable: 'li',
      onEnd:function(){
        const newOrder = Array.from(listEl.querySelectorAll('li span')).map(s=>s.textContent);
        const cur = getPracticeTemplates() || {};
        cur[lvl] = newOrder;
        // savePracticeTemplates æœƒåŒæ­¥åˆ° localStorage èˆ‡ Firebaseï¼ˆè‹¥å¯ç”¨ï¼‰
        savePracticeTemplates(cur);
        renderPracticeQuickButtons();
      }
    });
  }catch(e){}

  
}

// ---------- add practice template ----------
$('addPracticeBtn').onclick = ()=>{
  const txt = ($('newPractice') && $('newPractice').value || '').trim();
  if(!txt) return alert('è«‹è¼¸å…¥ç¯„æœ¬');
  const lvl = ($('editPracticeLevel') && $('editPracticeLevel').value) || '1';
  const cur = getPracticeTemplates() || {};
  cur[lvl] = cur[lvl] || [];
  cur[lvl].push(txt);
  savePracticeTemplates(cur);
  if($('newPractice')) $('newPractice').value = '';
  loadPracticeList();
  renderPracticeQuickButtons();
};

const exportPracticeBtn = $('exportPracticeBtn');
if(exportPracticeBtn){
  exportPracticeBtn.onclick = ()=>{
    const data = getPracticeTemplates() || {};
    const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'practiceTemplates.json'; a.click();
  };
}
const importPracticeBtn = $('importPracticeBtn');
if(importPracticeBtn){
  importPracticeBtn.onclick = ()=>{
    const input = document.createElement('input');
    input.type = 'file'; input.accept = 'application/json';
    input.onchange = ()=>{
      const f = input.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const parsed = JSON.parse(r.result);
          if(typeof parsed !== 'object') throw 0;
          savePracticeTemplates(parsed);
          loadPracticeList();
          renderPracticeQuickButtons();
          alert('åŒ¯å…¥æˆåŠŸ');
        }catch(e){ alert('æ ¼å¼éŒ¯èª¤'); }
      };
      r.readAsText(f);
    };
    input.click();
  };
}
const resetPracticeBtn = $('resetPracticeBtn');
if(resetPracticeBtn){
  resetPracticeBtn.onclick = ()=>{
    if(!confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­ï¼Ÿæ­¤å‹•ä½œæœƒåˆªé™¤è‡ªè¨‚ç¯„æœ¬')) return;
    savePracticeTemplates(JSON.parse(JSON.stringify(defaultPracticeTemplatesByLevel)));
    loadPracticeList();
    renderPracticeQuickButtons();
    alert('å·²é‡ç½®ç‚ºé è¨­');
  };
}

// ---------- éœ€åŠ å¼·ï¼ˆNeedï¼‰ï¼šè¼‰å…¥ / ç·¨è¼¯ / å¿«é€Ÿæ–°å¢ ----------
function loadNeedList(){
  ensureNeedTemplatesInitialized();
  const lvlEl = $('editNeedLevel');
  if(!lvlEl) return;
  const lvl = lvlEl.value || '1';
  const listEl = $('needList');
  if(!listEl) return;
  listEl.innerHTML = '';
  const all = getNeedTemplates() || {};
  all[lvl] = Array.isArray(all[lvl]) ? all[lvl] : [];
  all[lvl].forEach((txt, idx)=>{
    const li = document.createElement('li');
    li.className = 'degree-item';
    const span = document.createElement('span');
    span.textContent = txt; span.title = 'é›™æ“Šç·¨è¼¯';
    span.addEventListener('dblclick', ()=>{
      if(li.querySelector('input')) return;
      const input = document.createElement('input'); input.type='text'; input.value = txt;
      input.style.width='100%'; input.style.padding='6px'; input.style.borderRadius='6px'; input.style.border='1px solid #ccc';
      li.replaceChild(input, span); input.focus(); input.select();
      const cancel = ()=>{ if(li.contains(input)) li.replaceChild(span, input); };
      const save = ()=>{
        const v = input.value.trim();
        if(!v){ alert('å…§å®¹ä¸å¯ç‚ºç©º'); input.focus(); return; }
        const cur = getNeedTemplates() || {};
        cur[lvl] = cur[lvl] || [];
        cur[lvl][idx] = v;
        saveNeedTemplates(cur);
        loadNeedList();
        renderNeedQuickButtons();
      };
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); save(); } else if(e.key==='Escape'){ e.preventDefault(); cancel(); } });
      input.addEventListener('blur', ()=>{ if(input.value.trim() === txt) cancel(); else save(); });
    });
    const del = document.createElement('button');
    del.textContent = 'âœ•';
    del.onclick = ()=>{ if(!confirm('åˆªé™¤æ­¤é …ç›®ï¼Ÿ')) return; const cur = getNeedTemplates() || {}; cur[lvl] = cur[lvl] || []; cur[lvl].splice(idx,1); saveNeedTemplates(cur); loadNeedList(); renderNeedQuickButtons(); };
    li.appendChild(span); li.appendChild(del); listEl.appendChild(li);
  });
  try{
    if(listEl._sortable && typeof listEl._sortable.destroy === 'function'){
      try{ listEl._sortable.destroy(); }catch(e){}
      listEl._sortable = null;
    }
    listEl._sortable = Sortable.create(listEl, {
      animation:150,
      handle: 'span',
      draggable: 'li',
      onEnd:function(){
        const newOrder = Array.from(listEl.querySelectorAll('li span')).map(s=>s.textContent);
        const cur = getNeedTemplates() || {};
        cur[lvl] = newOrder;
        saveNeedTemplates(cur);
        renderNeedQuickButtons();
      }
    });
  }catch(e){}
}

// add need
if($('addNeedBtn')) $('addNeedBtn').onclick = ()=>{
  const txt = ($('newNeed') && $('newNeed').value || '').trim();
  if(!txt) return alert('è«‹è¼¸å…¥é …ç›®');
  const lvl = ($('editNeedLevel') && $('editNeedLevel').value) || '1';
  const cur = getNeedTemplates() || {};
  cur[lvl] = cur[lvl] || [];
  cur[lvl].push(txt);
  saveNeedTemplates(cur);
  if($('newNeed')) $('newNeed').value = '';
  loadNeedList();
  renderNeedQuickButtons();
};

// export / import / reset
if($('exportNeedBtn')) $('exportNeedBtn').onclick = ()=>{ const data = getNeedTemplates() || {}; const blob = new Blob([JSON.stringify(data)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'needTemplates.json'; a.click(); };
if($('importNeedBtn')) $('importNeedBtn').onclick = ()=>{
  const input = document.createElement('input'); input.type = 'file'; input.accept = 'application/json';
  input.onchange = ()=>{
    const f = input.files[0]; if(!f) return;
    const r = new FileReader();
    r.onload = ()=>{
      try{ const parsed = JSON.parse(r.result); if(typeof parsed !== 'object') throw 0; saveNeedTemplates(parsed); loadNeedList(); renderNeedQuickButtons(); alert('åŒ¯å…¥æˆåŠŸ'); }catch(e){ alert('æ ¼å¼éŒ¯èª¤'); }
    };
    r.readAsText(f);
  };
  input.click();
};
if($('resetNeedBtn')) $('resetNeedBtn').onclick = ()=>{
  if(!confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­ï¼Ÿæ­¤å‹•ä½œæœƒåˆªé™¤è‡ªè¨‚é …ç›®')) return;
  saveNeedTemplates(JSON.parse(JSON.stringify(defaultNeedTemplatesByLevel)));
  loadNeedList();
  renderNeedQuickButtons();
  alert('å·²é‡ç½®ç‚ºé è¨­');
};

// render quick buttons for need (in generator)
function renderNeedQuickButtons(){
  ensureNeedTemplatesInitialized();
  const templates = getNeedTemplates() || {};
  const lvl = $('level') ? ($('level').value || '1') : '1';
  const list = templates[lvl] || [];
  const toggle = $('needQuickToggle');
  const listEl = $('needQuickList');
  if(!toggle || !listEl) return;
  listEl.innerHTML = '';
  if(list.length === 0){
    const hint = document.createElement('div');
    hint.style.color = 'var(--gray)';
    hint.style.fontSize = '13px';
    hint.textContent = 'æ­¤ç­‰ç´šå°šç„¡é …ç›®ï¼Œå¯åˆ°ã€Œéœ€åŠ å¼·ç·¨è¼¯ã€æ–°å¢';
    listEl.appendChild(hint);
    return;
  }
  list.forEach((t)=>{
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'btn ghost';
    item.style.display = 'block';
    item.style.width = '100%';
    item.style.textAlign = 'left';
    item.style.marginBottom = '6px';
    item.style.padding = '6px 8px';
    item.textContent = t;
    item.title = t;
    item.onclick = (e)=>{
      e.stopPropagation();
      const ta = $('needImprove');
      if(!ta) return;
      const needPunct = ta.value.trim().length > 0;
      if(needPunct) ta.value = ta.value + 'ã€' + t;
      else ta.value = ta.value + t;
      ta.focus();
      try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
    };
    listEl.appendChild(item);
  });
}

// ---------- è£œï¼šrenderPracticeQuickButtonsï¼ˆèˆ‡ need å°ç¨±ï¼‰ ----------
function renderPracticeQuickButtons(){
  ensurePracticeTemplatesInitialized();
  const templates = getPracticeTemplates() || {};
  const lvl = $('level') ? ($('level').value || '1') : '1';
  const list = templates[lvl] || [];
  const toggle = $('practiceQuickToggle');
  const listEl = $('practiceQuickList');
  if(!toggle || !listEl) return;
  listEl.innerHTML = '';
  if(list.length === 0){
    const hint = document.createElement('div');
    hint.style.color = 'var(--gray)';
    hint.style.fontSize = '13px';
    hint.textContent = 'æ­¤ç­‰ç´šå°šç„¡é …ç›®ï¼Œå¯åˆ°ã€Œå»ºè­°ç·´ç¿’ç·¨è¼¯ã€æ–°å¢';
    listEl.appendChild(hint);
    return;
  }
  list.forEach((t)=>{
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'btn ghost';
    item.style.display = 'block';
    item.style.width = '100%';
    item.style.textAlign = 'left';
    item.style.marginBottom = '6px';
    item.style.padding = '6px 8px';
    item.textContent = t;
    item.title = t;
    item.onclick = (e)=>{
      e.stopPropagation();
      const ta = $('practice');
      if(!ta) return;
      const has = ta.value.trim().length > 0;
      ta.value = has ? (ta.value + 'ã€' + t) : t;
      ta.focus();
      try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
    };
    listEl.appendChild(item);
  });
}

// ---------- è£œï¼šç•¶ ç·¨è¼¯ã€ŒåŠ å¼·å…§å®¹ã€çš„ç­‰ç´šæ”¹è®Šæ™‚æ›´æ–°åˆ—è¡¨ ----------
if($('editNeedLevel')) $('editNeedLevel').addEventListener('change', loadNeedList);

// ---------- è£œï¼šç•¶ generator çš„ç­‰ç´šæ”¹è®Šæ™‚ï¼ŒåŒæ­¥æ›´æ–°å…©çµ„å¿«é€ŸæŒ‰éˆ•ï¼ˆåˆ†é–‹å‘¼å«ï¼Œé¿å…è¡çªï¼‰ ----------
if($('level')) {
  $('level').addEventListener('change', ()=>{
    try{ renderNeedQuickButtons(); }catch(e){}
    try{ renderPracticeQuickButtons(); }catch(e){}
    // ä¸è‡ªå‹•æ‰“é–‹ä»»ä½•ä¸‹æ‹‰ï¼Œåªæ›´æ–°å…§å®¹
  });
 }

 // åœ¨é é¢è¼‰å…¥å¾Œç¢ºä¿å…©çµ„æŒ‰éˆ•å·²æ¸²æŸ“ï¼ˆè‹¥å·²æœ‰å…¶ä»– load handlerï¼Œæœ¬æ®µç‚ºè£œå¼·ï¼Œä¸è¡çªï¼‰
 window.addEventListener('load', ()=>{
  try{ renderNeedQuickButtons(); }catch(e){}
  try{ renderPracticeQuickButtons(); }catch(e){}
 });
 

// ---------- è£œï¼šéœ€åŠ å¼·ç·¨è¼¯é çš„å¿«é€Ÿæ–°å¢æŒ‰éˆ•é–‹é—œè™•ç† ----------
function openNeedQuickList(){
  // äº’æ–¥ï¼šé–‹å•Ÿéœ€åŠ å¼·å‰å…ˆé—œé–‰ practice
  try{ closePracticeQuickList(); }catch(e){}
  const toggle = $('needQuickToggle'), listEl = $('needQuickList');
  if(!toggle || !listEl) return;
  try{ renderNeedQuickButtons(); }catch(e){}
  listEl.style.display = 'block';
  toggle.setAttribute('aria-expanded','true');
  setTimeout(()=>{ document.addEventListener('click', onDocClickCloseNeed); }, 0);
}
function closeNeedQuickList(){
   const toggle = $('needQuickToggle'), listEl = $('needQuickList');
   if(!toggle || !listEl) return;
   listEl.style.display = 'none';
   toggle.setAttribute('aria-expanded','false');
   document.removeEventListener('click', onDocClickCloseNeed);
 }
 function onDocClickCloseNeed(e){
   const wrap = document.getElementById('needQuickButtons');
   if(!wrap) return closeNeedQuickList();
   if(!wrap.contains(e.target)) closeNeedQuickList();
 }
 const needToggleEl = $('needQuickToggle');
 if(needToggleEl){
   needToggleEl.addEventListener('click', (e)=>{
     e.stopPropagation();
     const listEl = $('needQuickList');
     if(!listEl) return;
     if(listEl.style.display === 'block') closeNeedQuickList();
     else openNeedQuickList();
   });
 }
 
 // Practice ç¨ç«‹è™•ç†
 function openPracticeQuickList(){
  // äº’æ–¥ï¼šé–‹å•Ÿ practice å‰å…ˆé—œé–‰ need
  try{ closeNeedQuickList(); }catch(e){}
  const toggle = $('practiceQuickToggle'), listEl = $('practiceQuickList');
  if(!toggle || !listEl) return;
  try{ renderPracticeQuickButtons(); }catch(e){}
  listEl.style.display = 'block';
  toggle.setAttribute('aria-expanded','true');
  setTimeout(()=>{ document.addEventListener('click', onDocClickClosePractice); }, 0);
 }
 function closePracticeQuickList(){
   const toggle = $('practiceQuickToggle'), listEl = $('practiceQuickList');
   if(!toggle || !listEl) return;
   listEl.style.display = 'none';
   toggle.setAttribute('aria-expanded','false');
   document.removeEventListener('click', onDocClickClosePractice);
 }
 function onDocClickClosePractice(e){
   const wrap = document.getElementById('practiceQuickButtons');
   if(!wrap) return closePracticeQuickList();
   if(!wrap.contains(e.target)) closePracticeQuickList();
 }
 const practiceToggleEl = $('practiceQuickToggle');
 if(practiceToggleEl){
   practiceToggleEl.addEventListener('click', (e)=>{
     e.stopPropagation();
     const listEl = $('practiceQuickList');
     if(!listEl) return;
     if(listEl.style.display === 'block') closePracticeQuickList();
     else openPracticeQuickList();
   });
 }
 
 // ä¿éšªï¼šæŒ‰ç­‰ç´šè®Šæ›´æ™‚ç¢ºä¿åˆ—è¡¨èˆ‡æŒ‰éˆ•ç‹€æ…‹åŒæ­¥ï¼ˆä¸æœƒå½±éŸ¿å…¶ä»–é‚è¼¯ï¼‰
 window.addEventListener('load', ()=>{
  try{ renderNeedQuickButtons(); }catch(e){}
  try{ renderPracticeQuickButtons(); }catch(e){}
 });
 

// ---------- è£œï¼šè®“ç·¨è¼¯é çš„æ–°å¢è¼¸å…¥æ¬„ä½æŒ‰ Enter å³å¯æ–°å¢ ----------
(function(){
  function bindEnterToAdd(inputId, btnId){
    const bind = ()=>{
      const inp = document.getElementById(inputId);
      const btn = document.getElementById(btnId);
      if(!inp) return;
      inp.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          // è‹¥æœ‰å°æ‡‰æŒ‰éˆ•å°±è§¸ç™¼å®ƒçš„ click handlerï¼Œå¦å‰‡ç›´æ¥å‘¼å«å·²å­˜åœ¨çš„æ–°å¢é‚è¼¯
          if(btn) btn.click();
          else {
            // safety: try known handlers
            if(inputId === 'newDegree' && typeof window.addDegree === 'function') window.addDegree();
            if(inputId === 'newPractice' && typeof window.addPractice === 'function') window.addPractice();
            if(inputId === 'newNeed' && typeof window.addNeed === 'function') window.addNeed();
          }
        }
      });
    };
    // è‹¥ DOM å°šæœª readyï¼Œå°±ç­‰å¾… load å†ç¶å®šï¼ˆæ­¤æª” script æ”¾æ–¼ body åº•éƒ¨é€šå¸¸å¯ä»¥ç›´æ¥ç¶å®šï¼‰
    if(document.readyState === 'complete' || document.readyState === 'interactive'){
      bind();
    } else {
      window.addEventListener('load', bind);
    }
  }

  bindEnterToAdd('newDegree','addDegreeBtn');
  bindEnterToAdd('newPractice','addPracticeBtn');
  bindEnterToAdd('newNeed','addNeedBtn');
})();


 // ---------- è£œï¼šæ¸…ç©º/æ¢å¾©æŒ‰éˆ•è¡Œç‚ºï¼ˆbind åˆ° #toggleResetRestoreBtnï¼‰ ----------
(function bindToggleResetRestore(){
  const btn = $('toggleResetRestoreBtn');
  if(!btn) return;

  btn.addEventListener('click', (e)=>{
    e.preventDefault();
    // å¦‚æœå°šæœªæ¸…ç©º -> å„²å­˜ç‹€æ…‹ä¸¦æ¸…ç©º
    if(!isCleared){
      // å¦‚æœç›®å‰æœ‰è¼¸å…¥å°ˆç”¨çš„æ¸…ç©ºç‹€æ…‹ï¼Œå…ˆæŠŠè¼¸å…¥çš„æš«å­˜å€¼å–å‡ºï¼Œä¸¦å–æ¶ˆè©²è¼¸å…¥æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
      if(isInputsCleared && savedInputsState && Object.keys(savedInputsState).length){
        // æŠŠè¼¸å…¥æ¢å¾©æŒ‰éˆ•å›å¾©æˆã€Œæ¸…ç©ºè¼¸å…¥ã€ç‹€æ…‹
        const ibtn = $('toggleResetInputsBtn');
        if(ibtn){ ibtn.textContent = 'æ¸…ç©ºè¼¸å…¥'; ibtn.classList.remove('restore'); ibtn.classList.add('clear'); }
        try{ sessionStorage.removeItem('savedInputsState_v1'); }catch(e){}
        isInputsCleared = false;
        savedInputsState = {};
        stopInputsClearedMonitor();
      }
      // å„²å­˜è¡¨å–®ç‹€æ…‹
      savedInputState = {
        level: $('level') ? $('level').value : '',
        rating: $('rating') ? $('rating').value : '',
        levelState: $('levelState') ? $('levelState').value : '',
        type: $('type') ? $('type').value : '',
        character: $('character') ? $('character').value : '',
        degree: $('degreeSelect') ? $('degreeSelect').value : '',
        // å¦‚æœä¹‹å‰æ˜¯è¼¸å…¥æ¸…ç©ºä¸”æœ‰æš«å­˜ï¼Œå„ªå…ˆä½¿ç”¨æš«å­˜å€¼ï¼ˆå¯ä¿ç•™ä½¿ç”¨è€…åœ¨æ¸…ç©ºè¼¸å…¥å‰çš„å…§å®¹ï¼‰
        needImprove: (savedInputsState && savedInputsState.needImprove) ? savedInputsState.needImprove : ($('needImprove') ? $('needImprove').value : ''),
        practice: (savedInputsState && savedInputsState.practice) ? savedInputsState.practice : ($('practice') ? $('practice').value : ''),
        otherNotes: (savedInputsState && savedInputsState.otherNotes) ? savedInputsState.otherNotes : ($('otherNotes') ? $('otherNotes').value : ''),
        reverseFoot: (savedInputsState && typeof savedInputsState.reverseFoot !== 'undefined') ? !!savedInputsState.reverseFoot : ($('reverseFoot') ? !!$('reverseFoot').checked : false)
      };
      // å¿…è¦æŠ€èƒ½ç‹€æ…‹
      savedInputState.remarks = Array.from(document.querySelectorAll('#requiredSkills .remark'))
        .filter(r=>r.tagName==='INPUT')
        .map(r=>({ value: r.value, state: r.dataset.state || (r.checked ? 'yes' : 'no') }));
      // æ ¸å¿ƒæŠ€èƒ½ç‹€æ…‹
      const coreCols = document.querySelectorAll('#skillBlockCore .skill-col');
      savedInputState.core = Array.from(coreCols).map(col=>{
        const a = col.querySelector('button.active'); return a ? a.textContent : '';
      });

      try{ sessionStorage.setItem('savedInputState_v1', JSON.stringify(savedInputState)); }catch(e){}

      // æ¸…ç©º UIï¼ˆä¿å®ˆè™•ç†ï¼‰
      if($('level')) $('level').value = '';
      if($('rating')) $('rating').value = 'æœªè©•ç´š';
      if($('levelState')) $('levelState').value = '';
      if($('type')) $('type').value = '';
      if($('character')) $('character').value = '';
      loadDegreeOptions(); // æœƒæ ¹æ“š level æ›´æ–° degreeSelect
      if($('needImprove')) $('needImprove').value = '';
      if($('practice')) $('practice').value = '';
      if($('otherNotes')) $('otherNotes').value = '';
      if($('reverseFoot')) $('reverseFoot').checked = false;
      // æ¸…é™¤å¿…è¦æŠ€èƒ½
      document.querySelectorAll('#requiredSkills .remark').forEach(r=>{ if(r.tagName==='INPUT') setRemarkStateFor(r,'no'); });
      // æ¸…é™¤æ ¸å¿ƒæŠ€èƒ½é¸å–ï¼ˆä¿ç•™ UI ç©ºç™½ï¼‰
      document.querySelectorAll('#skillBlockCore .skill-col button').forEach(b=>b.classList.remove('active'));
      // è®Šæ›´å¾Œç«‹å³æ›´æ–°é è¦½
      try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
      if($('coreOutput')) $('coreOutput').textContent = '';

      // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹ä¸¦å•Ÿå‹•ç›£è½ä»¥ä¾¿åµæ¸¬äº’å‹•å¾Œå–æ¶ˆæ¢å¾©
      btn.textContent = 'æ¢å¾©å…¨éƒ¨';
      btn.classList.remove('clear'); btn.classList.add('restore');
      isCleared = true;
      startClearedMonitor();
      return;
    }

    // å¦‚æœç›®å‰ç‚ºå·²æ¸…ç©ºç‹€æ…‹ -> å˜—è©¦æ¢å¾©
    let s = savedInputState && Object.keys(savedInputState).length ? savedInputState : null;
    if(!s){
      try{ s = JSON.parse(sessionStorage.getItem('savedInputState_v1') || '{}'); }catch(e){ s = {}; }
    }
    if(!s || Object.keys(s).length === 0){
      alert('æ‰¾ä¸åˆ°å¯æ¢å¾©çš„è¼¸å…¥è³‡æ–™');
      return;
    }

    // é‚„åŸå€¼
    if('level' in s && $('level')) $('level').value = s.level || '';
    if('rating' in s && $('rating')) $('rating').value = s.rating || 'æœªè©•ç´š';
    if('levelState' in s && $('levelState')) $('levelState').value = s.levelState || '';
    if('type' in s && $('type')) $('type').value = s.type || '';
    if('character' in s && $('character')) $('character').value = s.character || '';
    loadDegreeOptions();
    if('degree' in s && $('degreeSelect')) $('degreeSelect').value = s.degree || '';
    if('needImprove' in s && $('needImprove')) $('needImprove').value = s.needImprove || '';
    if('practice' in s && $('practice')) $('practice').value = s.practice || '';
    if('otherNotes' in s && $('otherNotes')) $('otherNotes').value = s.otherNotes || '';
    if('reverseFoot' in s && $('reverseFoot')) $('reverseFoot').checked = !!s.reverseFoot;
    if(Array.isArray(s.remarks)){
      const inputs = Array.from(document.querySelectorAll('#requiredSkills .remark')).filter(r=>r.tagName==='INPUT');
      inputs.forEach((r,i)=>{ const st = (s.remarks[i] && s.remarks[i].state) ? s.remarks[i].state : 'no'; setRemarkStateFor(r, st); });
    }
    if(Array.isArray(s.core) && s.core.length){
      applyCoreStateArray(s.core);
    }

    // é‡æ–°ç”¢ç”Ÿé è¦½ï¼Œè®“ UI èˆ‡è©•èªåŒæ­¥
    try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}
    if($('coreOutput')) $('coreOutput').textContent = (s.core || []).filter(Boolean).join(' ');

    // é‡è¨­æŒ‰éˆ•ç‹€æ…‹ä¸¦åœæ­¢ç›£è½
    btn.textContent = 'æ¸…ç©ºå…¨éƒ¨';
    btn.classList.remove('restore'); btn.classList.add('clear');
    isCleared = false;
    stopClearedMonitor();
    savedInputState = {};
    try{ sessionStorage.removeItem('savedInputState_v1'); }catch(e){}
  });
})();


 // ---------- æ–°å¢ï¼šè¼¸å…¥å°ˆç”¨æ¸…ç©º/æ¢å¾©æŒ‰éˆ•è¡Œç‚ºï¼ˆbind åˆ° #toggleResetInputsBtnï¼‰ ----------
(function bindToggleResetInputs(){
  const ibtn = $('toggleResetInputsBtn');
  if(!ibtn) return;

  ibtn.addEventListener('click', (e)=>{
    e.preventDefault();
    // è‹¥å°šæœªæ¸…ç©ºè¼¸å…¥ -> å„²å­˜è¼¸å…¥æ¬„ä½ç‹€æ…‹ä¸¦æ¸…ç©º
    if(!isInputsCleared){
      savedInputsState = {
        needImprove: $('needImprove') ? $('needImprove').value : '',
        practice: $('practice') ? $('practice').value : '',
        otherNotes: $('otherNotes') ? $('otherNotes').value : '',
        reverseFoot: $('reverseFoot') ? !!$('reverseFoot').checked : false
      };
      try{ sessionStorage.setItem('savedInputsState_v1', JSON.stringify(savedInputsState)); }catch(e){}

      // æ¸…ç©ºè¼¸å…¥æ¬„ä½
      if($('needImprove')) $('needImprove').value = '';
      if($('practice')) $('practice').value = '';
      if($('otherNotes')) $('otherNotes').value = '';
      if($('reverseFoot')) $('reverseFoot').checked = false;
      try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}

      // åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
      ibtn.textContent = 'æ¢å¾©è¼¸å…¥'; ibtn.classList.remove('clear'); ibtn.classList.add('restore');
      isInputsCleared = true;
      startInputsClearedMonitor();

      // å¦‚æœåŒæ™‚å…¨åŸŸæ˜¯æ¸…ç©º/æ¢å¾©ç‹€æ…‹ï¼Œå–æ¶ˆå…¨åŸŸçš„æ¢å¾©ï¼ˆäº’æ–¥ï¼‰
      const fullBtn = $('toggleResetRestoreBtn');
      if(fullBtn && isCleared){
        fullBtn.textContent = 'æ¸…ç©ºå…¨éƒ¨'; fullBtn.classList.remove('restore'); fullBtn.classList.add('clear');
        isCleared = false;
        savedInputState = {};
        try{ sessionStorage.removeItem('savedInputState_v1'); }catch(e){}
        stopClearedMonitor();
      }
      return;
    }

    // è‹¥ç›®å‰ç‚ºå·²æ¸…ç©ºè¼¸å…¥ç‹€æ…‹ -> å˜—è©¦æ¢å¾©è¼¸å…¥æ¬„ä½
    let s = savedInputsState && Object.keys(savedInputsState).length ? savedInputsState : null;
    if(!s){
      try{ s = JSON.parse(sessionStorage.getItem('savedInputsState_v1') || '{}'); }catch(e){ s = {}; }
    }
    if(!s || Object.keys(s).length === 0){ alert('æ‰¾ä¸åˆ°å¯æ¢å¾©çš„è¼¸å…¥è³‡æ–™'); return; }

    if('needImprove' in s && $('needImprove')) $('needImprove').value = s.needImprove || '';
    if('practice' in s && $('practice')) $('practice').value = s.practice || '';
    if('otherNotes' in s && $('otherNotes')) $('otherNotes').value = s.otherNotes || '';
    if('reverseFoot' in s && $('reverseFoot')) $('reverseFoot').checked = !!s.reverseFoot;
    try{ if(typeof generatePreview === 'function') generatePreview(); }catch(e){}

    ibtn.textContent = 'æ¸…ç©ºè¼¸å…¥'; ibtn.classList.remove('restore'); ibtn.classList.add('clear');
    isInputsCleared = false;
    stopInputsClearedMonitor();
    savedInputsState = {};
    try{ sessionStorage.removeItem('savedInputsState_v1'); }catch(e){}
  });
})();
</script>
</body>
</html>




